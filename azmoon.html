<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø³Ø§Ù„Ù† Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ù‡ÙˆØ´Ù…Ù†Ø¯</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" />
    <style>
        :root { --primary: #2c3e50; --accent: #8e44ad; --bg: #f0f2f5; --success: #27ae60; --danger: #c0392b; --warning: #f1c40f; }
        body { font-family: 'Vazirmatn', sans-serif; background: var(--bg); margin: 0; padding: 15px; min-height: 100vh; display: flex; flex-direction: column; align-items: center; user-select: none; -webkit-tap-highlight-color: transparent; }

        .card { background: white; width: 100%; max-width: 650px; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); margin-bottom: 20px; text-align: center; animation: fadeIn 0.5s; position: relative; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .btn { border: none; padding: 12px; border-radius: 12px; font-size: 1rem; cursor: pointer; font-family: inherit; width: 100%; font-weight: bold; transition: 0.2s; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:active { transform: scale(0.98); }
        .btn-start { background: var(--accent); color: white; box-shadow: 0 4px 15px rgba(142, 68, 173, 0.3); }
        .btn-next { background: #2980b9; color: white; }
        .btn-finish { background: var(--success); color: white; display: none; }
        .btn-back { background: #ecf0f1; color: #2c3e50; }
        
        .exam-item { background: #fff; border: 2px solid #e1bee7; border-radius: 16px; padding: 15px; margin-bottom: 12px; text-align: right; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .exam-item:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .exam-item.locked { background: #f8f9fa; border-color: #bdc3c7; opacity: 0.9; }
        
        .exam-info h4 { margin: 0; color: #4a148c; font-size: 1rem; }
        .exam-info small { color: #7f8c8d; font-size: 0.8rem; display: block; margin-top: 5px; }
        
        .timer-box { font-size: 1.4rem; font-weight: bold; color: var(--danger); background: #fadbd8; padding: 5px 15px; border-radius: 12px; display: inline-block; }

        /* âœ… Ø§ØµÙ„Ø§Ø­ Ù…Ù‡Ù…: Ø§Ø³ØªØ§ÛŒÙ„ Ø¹Ú©Ø³ Ø³ÙˆØ§Ù„ */
        .q-image { 
            width: 100%; 
            max-width: 100%; /* Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø¨ÛŒØ±ÙˆÙ† Ø²Ø¯Ú¯ÛŒ */
            height: auto; 
            max-height: 300px; 
            object-fit: contain; 
            border-radius: 12px; 
            border: 1px solid #eee; 
            margin: 15px 0; 
            cursor: zoom-in; 
            background: #fafafa; 
            display: block;
        }

        /* Ù„Ø§ÛŒØª Ø¨Ø§Ú©Ø³ */
        #lightbox { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: none; justify-content: center; align-items: center; cursor: zoom-out; backdrop-filter: blur(5px); }
        #lightbox img { max-width: 95%; max-height: 95%; border-radius: 10px; box-shadow: 0 0 50px rgba(255,255,255,0.2); animation: zoomIn 0.3s; }
        @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ */
        .option { background: #f8f9fa; border: 2px solid #e9ecef; padding: 15px; border-radius: 12px; margin-bottom: 10px; cursor: pointer; text-align: right; transition: 0.2s; display: flex; flex-direction: column; align-items: flex-start; gap: 8px; }
        .option.selected { background: #e8f6f3; border-color: var(--success); color: var(--success); font-weight: bold; box-shadow: 0 4px 10px rgba(39, 174, 96, 0.2); transform: scale(1.01); }
        .option img { max-width: 100%; height: auto; max-height: 200px; border-radius: 8px; border: 1px solid #ddd; object-fit: contain; align-self: center; margin-top: 5px; }

        /* Ù†ÙˆØ§Ø± Ù†Ù…Ø±Ù‡ */
        .score-container { margin: 40px 0 20px 0; position: relative; padding-top: 20px; direction: ltr; } 
        .score-bar { height: 25px; width: 100%; border-radius: 15px; background: linear-gradient(90deg, #e74c3c 0%, #e74c3c 39%, #f1c40f 40%, #f1c40f 59%, #2ecc71 60%, #2ecc71 79%, #8e44ad 80%, #8e44ad 100%); position: relative; box-shadow: inset 0 3px 6px rgba(0,0,0,0.2); }
        
        .score-pointer { 
            position: absolute; 
            top: -10px; 
            width: 0; height: 0; 
            border-left: 10px solid transparent; 
            border-right: 10px solid transparent; 
            border-top: 18px solid #2c3e50; 
            transform: translateX(-50%); 
            transition: left 1.5s cubic-bezier(0.22, 1, 0.36, 1); 
            left: 0%; z-index: 10;
        }
        .score-pointer::after { content: ''; position: absolute; top: -20px; left: -2px; width: 4px; height: 4px; background: white; border-radius: 50%; }

        .score-text { font-size: 2rem; font-weight: bold; margin-top: 25px; color: #2c3e50; text-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .stat-grid { display: flex; justify-content: space-around; margin: 20px 0; background: #f8f9fa; padding: 15px; border-radius: 12px; }
        .stat-item { text-align: center; }
        .stat-num { font-size: 1.3rem; font-weight: bold; display: block; }
        .stat-label { font-size: 0.8rem; color: #7f8c8d; }

        #loading { color: #7f8c8d; font-weight: bold; margin-top: 20px; }
        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9998; }
        
        .review-q { border-bottom: 1px solid #eee; padding: 20px 0; }
        .r-opt { padding: 10px; margin: 5px 0; border-radius: 10px; border: 1px solid #eee; background: #fff; }
    </style>
</head>
<body>

    <canvas id="confetti-canvas"></canvas>

    <div id="lightbox" onclick="this.style.display='none'">
        <img id="lightboxImg" src="">
    </div>

    <div id="lobby" class="card">
        <div style="font-size: 3.5rem; margin-bottom: 5px;">ğŸ“</div>
        <h2 id="welcomeText" style="margin:0 0 10px 0;">Ø³Ø§Ù„Ù† Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</h2>
        <div id="loading">â³ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª...</div>
        <div id="resumeAlert" style="display:none; background:#fff3cd; color:#856404; padding:12px; border-radius:12px; margin-bottom:15px; border:1px solid #ffeeba;">âš ï¸ Ø¢Ø²Ù…ÙˆÙ† Ù†Ø§ØªÙ…Ø§Ù… Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯!</div>
        <div id="examList"></div>
        <button class="btn btn-back" onclick="window.location.href='index.html'">ğŸ  Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ú©Ù„Ø§Ø³</button>
    </div>

    <div id="examArea" class="card" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #f1f2f6; padding-bottom: 10px;">
            <span id="qProgress" style="font-weight:bold; color:var(--primary);">Ø³ÙˆØ§Ù„ Û±</span>
            <div id="timer" class="timer-box">00:00</div>
        </div>
        <img id="questionImage" class="q-image" src="" onclick="openLightbox(this.src)" style="display:none;">
        <h3 id="questionText" style="text-align: right; line-height: 1.8; font-size: 1.1rem; color: #34495e;">...</h3>
        <div id="optionsContainer"></div>
        <button id="btnNext" class="btn btn-next" onclick="nextQuestion()">Ø³ÙˆØ§Ù„ Ø¨Ø¹Ø¯ÛŒ â¬…ï¸</button>
        <button id="btnFinish" class="btn btn-finish" onclick="finishExam()">âœ… Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ Ø¢Ø²Ù…ÙˆÙ†</button>
    </div>

    <div id="reportCard" class="card" style="display: none;">
        <h2 style="color:var(--accent);">ğŸ“Š Ù†ØªÛŒØ¬Ù‡ Ø¹Ù…Ù„Ú©Ø±Ø¯</h2>
        
        <div class="score-container">
            <div class="score-pointer" id="scorePointer"></div>
            <div class="score-bar"></div>
            <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#aaa; margin-top:5px; direction:ltr;">
                <span>0%</span><span>40%</span><span>60%</span><span>80%</span><span>100%</span>
            </div>
        </div>
        
        <div id="qualitativeScore" class="score-text">...</div>

        <div class="stat-grid">
            <div class="stat-item">
                <span id="resCorrect" class="stat-num" style="color:var(--success)">0</span>
                <span class="stat-label">Ø¯Ø±Ø³Øª âœ…</span>
            </div>
            <div class="stat-item">
                <span id="resWrong" class="stat-num" style="color:var(--danger)">0</span>
                <span class="stat-label">ØºÙ„Ø· âŒ</span>
            </div>
            <div class="stat-item">
                <span id="resEmpty" class="stat-num" style="color:#95a5a6">0</span>
                <span class="stat-label">Ù†Ø²Ø¯Ù‡ âšª</span>
            </div>
        </div>

        <div id="xpMsg" style="background:#e8f6f3; color:#16a085; padding:10px; border-radius:10px; margin-bottom:15px; display:none; margin-top:20px;">
            âœ… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø± Ø³Ø±ÙˆØ± Ø«Ø¨Øª Ø´Ø¯.
        </div>

        <button id="btnReview" class="btn" style="background:#f39c12; color:white; display:none;" onclick="startReviewMode()">ğŸ” Ù…Ø±ÙˆØ± Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§</button>
        <button class="btn btn-back" onclick="location.reload()">ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„ÛŒØ³Øª Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§</button>
    </div>

    <div id="reviewArea" class="card" style="display: none; text-align: right;">
        <h3 style="text-align:center; color:#e67e22; border-bottom:2px solid #eee; padding-bottom:10px;">ğŸ§ ØªØ­Ù„ÛŒÙ„ Ø¢Ø²Ù…ÙˆÙ†</h3>
        <div id="reviewContent"></div>
        <button class="btn btn-back" onclick="location.reload()">Ù¾Ø§ÛŒØ§Ù† Ù…Ø±ÙˆØ±</button>
    </div>

    <script src="rank.js"></script>
    <script>
        const API_URL = "https://chamran-api.liara.run"; 
        const EXAM_STATE_KEY = "chamran_exam_active_session_v7"; 
        
        let currentUser = null;
        let examsMap = {};
        let currentExamId = null;
        let currentQuestions = [];
        let currentQIndex = 0;
        let userAnswers = {};
        let timerInterval;
        let timeRemaining = 0;

        function init() {
            const savedUser = localStorage.getItem('chamran_db_vfinal_creds');
            if(!savedUser) { window.location.href = 'index.html'; return; }
            try {
                currentUser = JSON.parse(savedUser);
                document.getElementById('welcomeText').innerText = `Ø³Ù„Ø§Ù… ${currentUser.displayName}`;
                SyncManager.init(currentUser.username, currentUser.password);
                
                const urlParams = new URLSearchParams(window.location.search);
                if(urlParams.get('mode') === 'history_review') {
                    // Ø¯Ø±ÛŒØ§ÙØª Ù…Ø³ØªÙ‚ÛŒÙ… ØªØ§Ø±Ú¯Øª Ø§Ø² URL
                    prepareReviewMode(urlParams.get('target'));
                } else {
                    performFullSync();
                }
            } catch(e) { window.location.href = 'index.html'; }
        }

        async function performFullSync() {
            try {
                // 1. Ù„Ø§Ú¯ÛŒÙ† Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø¯ÛŒØªØ§ÛŒ ÛŒÙˆØ²Ø± (Ø´Ø§Ù…Ù„ Ø³ÙˆØ§Ø¨Ù‚)
                const res = await fetch(API_URL, { method: 'POST', headers: { "Content-Type": "application/json" }, body: JSON.stringify({ action: 'login', username: currentUser.username, password: currentUser.password }) });
                const userData = await res.json();
                
                // 2. Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø³ÙˆØ§Ù„Ø§Øª Ø¢Ø²Ù…ÙˆÙ†
                const resExams = await fetch(API_URL, { method: 'POST', headers: { "Content-Type": "application/json" }, body: JSON.stringify({ action: 'get_exams' }) });
                const examData = await resExams.json();

                if(userData.status === 'success' && examData.status === 'success') {
                    // âœ… Ù…Ù‡Ù…: Ø¢Ù¾Ø¯ÛŒØª Ø±Ù†Ú© Ø³ÛŒØ³ØªÙ… Ø¨Ø§ Ø¯ÛŒØªØ§ÛŒ ØªØ§Ø²Ù‡ Ø³Ø±ÙˆØ±
                    RankSystem.init(userData.jsonData);
                    processExams(examData.data || []);
                    checkActiveSession();
                }
            } catch(e) { document.getElementById('loading').innerHTML = `<span style="color:red">âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„</span>`; }
        }

        function processExams(list) {
            examsMap = {};
            const container = document.getElementById('examList');
            container.innerHTML = '';
            document.getElementById('loading').style.display = 'none';

            if(list.length === 0) { container.innerHTML = "<p>Ø¢Ø²Ù…ÙˆÙ†ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>"; return; }

            list.reverse().forEach(ex => {
                examsMap[ex.id] = ex;
                // ØªØ¨Ø¯ÛŒÙ„ ID Ø¨Ù‡ Ø±Ø´ØªÙ‡ Ø¨Ø±Ø§ÛŒ Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø¯Ù‚ÛŒÙ‚
                const sId = String(ex.id);
                const userExams = RankSystem.data.exams || {};
                const score = userExams[sId]; 
                const isTaken = (score !== undefined);

                const div = document.createElement('div');
                div.className = `exam-item ${isTaken ? 'locked' : ''}`;
                
                if(isTaken) {
                    let quality = "";
                    if(score >= 20) quality = "ÙÙˆÙ‚â€ŒØ§Ù„Ø¹Ø§Ø¯Ù‡";
                    else if(score >= 16) quality = "Ø®ÛŒÙ„ÛŒ Ø®ÙˆØ¨";
                    else if(score >= 12) quality = "Ø®ÙˆØ¨";
                    else if(score >= 8) quality = "Ù‚Ø§Ø¨Ù„ Ù‚Ø¨ÙˆÙ„";
                    else quality = "Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªÙ„Ø§Ø´";

                    const color = score >= 15 ? '#27ae60' : (score < 10 ? '#c0392b' : '#f39c12');
                    
                    div.innerHTML = `
                        <div style="text-align:right">
                            <h4>${ex.title}</h4>
                            <small>Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡</small>
                        </div>
                        <div style="text-align:left">
                            <span style="font-weight:bold; color:${color}; font-size:0.9rem;">${quality}</span><br>
                            <button onclick="goToReview('${sId}')" style="background:none; border:none; color:#2980b9; cursor:pointer; font-size:0.8rem; padding:0; margin-top:5px;">ğŸ” Ù…Ø±ÙˆØ± Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§</button>
                        </div>`;
                } else {
                    div.innerHTML = `
                        <div><h4>${ex.title}</h4><small>${ex.time} Ø¯Ù‚ÛŒÙ‚Ù‡</small></div>
                        <button class="btn-start" style="padding:5px 15px; border-radius:8px; border:none; cursor:pointer;" onclick="checkStart('${ex.id}')">Ø´Ø±ÙˆØ¹</button>`;
                }
                container.appendChild(div);
            });
        }

        function checkStart(id) {
            const ex = examsMap[id];
            if(ex.pass && prompt("Ø±Ù…Ø²:") !== ex.pass) return alert("Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡");
            startExam(id);
        }

        function startExam(id) {
            const ex = examsMap[id];
            currentExamId = id;
            currentQuestions = ex.questions;
            userAnswers = {};
            currentQIndex = 0;
            localStorage.setItem(EXAM_STATE_KEY, JSON.stringify({ id, start: Date.now(), end: Date.now() + ex.time*60000 }));
            showExamUI(ex.time * 60);
            SyncManager.addToQueue('report', { lesson: `Ø¢Ø²Ù…ÙˆÙ†: ${ex.title}`, status: 'Ø´Ø±ÙˆØ¹' });
        }

        function showExamUI(time) {
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('examArea').style.display = 'block';
            let t = time;
            timerInterval = setInterval(() => {
                t--;
                const m = Math.floor(t/60), s = t%60;
                document.getElementById('timer').innerText = `${m}:${s<10?'0'+s:s}`;
                if(t<=0) { clearInterval(timerInterval); alert("Ø²Ù…Ø§Ù† ØªÙ…Ø§Ù… Ø´Ø¯!"); finishExam(true); }
            }, 1000);
            loadQuestion();
        }

        function loadQuestion() {
            const q = currentQuestions[currentQIndex];
            document.getElementById('qProgress').innerText = `Ø³ÙˆØ§Ù„ ${currentQIndex+1} Ø§Ø² ${currentQuestions.length}`;
            document.getElementById('questionText').innerText = q.q;
            
            const imgEl = document.getElementById('questionImage');
            if(q.img) { imgEl.src = q.img; imgEl.style.display = 'block'; } else imgEl.style.display = 'none';
            
            const cont = document.getElementById('optionsContainer');
            cont.innerHTML = '';
            q.options.forEach((opt, i) => {
                const val = i+1;
                const div = document.createElement('div');
                div.className = `option ${userAnswers[currentQIndex]==val ? 'selected' : ''}`;
                
                let content = opt;
                if(opt.startsWith('http') || opt.startsWith('/uploads')) content = `<img src="${opt}" onclick="event.stopPropagation(); openLightbox(this.src)">`;
                
                div.innerHTML = `<b>${val})</b> ${content}`;
                div.onclick = () => { userAnswers[currentQIndex] = val; loadQuestion(); }; 
                cont.appendChild(div);
            });

            document.getElementById('btnNext').style.display = currentQIndex < currentQuestions.length-1 ? 'block' : 'none';
            document.getElementById('btnFinish').style.display = currentQIndex === currentQuestions.length-1 ? 'block' : 'none';
        }

        function nextQuestion() { currentQIndex++; loadQuestion(); }

        function finishExam(forced = false) {
            clearInterval(timerInterval);
            localStorage.removeItem(EXAM_STATE_KEY);

            let correct = 0, wrong = 0, empty = 0;
            let wrongIndices = [];

            currentQuestions.forEach((q, i) => {
                if(!userAnswers[i]) empty++;
                else if(userAnswers[i] == q.correct) correct++;
                else { wrong++; wrongIndices.push(i+1); }
            });

            const score = parseFloat(((correct / currentQuestions.length) * 20).toFixed(1));

            // Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±
            SyncManager.addToQueue('claim_reward', {
                reward_type: 'exam', reward_id: currentExamId, exam_score: score,
                wrong_list: wrongIndices, user_answers: userAnswers
            });
            
            // âœ… ÙÛŒÚ©Ø³ Ø­ÛŒØ§ØªÛŒ: Ø¢Ù¾Ø¯ÛŒØª Ø¯Ø³ØªÛŒ Ø¯ÛŒØªØ§ÛŒ Ù„ÙˆÚ©Ø§Ù„ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¨Ù„Ø§ÙØ§ØµÙ„Ù‡ Ø¯Ø± Ø³ÙˆØ§Ø¨Ù‚ Ø¨ÛŒØ§ÛŒØ¯
            const sId = String(currentExamId);
            if(!RankSystem.data.exams) RankSystem.data.exams = {};
            if(!RankSystem.data.exam_details) RankSystem.data.exam_details = {};
            
            RankSystem.data.exams[sId] = score;
            RankSystem.data.exam_details[sId] = {
                score: score, wrong: wrongIndices, answers: userAnswers, date: new Date().toLocaleDateString('fa-IR')
            };

            showReportCard(score, correct, wrong, empty);
        }

        function showReportCard(score, correct, wrong, empty) {
            document.getElementById('examArea').style.display = 'none';
            document.getElementById('reportCard').style.display = 'block';

            document.getElementById('resCorrect').innerText = correct;
            document.getElementById('resWrong').innerText = wrong;
            document.getElementById('resEmpty').innerText = empty;

            setTimeout(() => { document.getElementById('scorePointer').style.left = ((score/20)*100) + '%'; }, 200);

            let qText = "", color = "";
            if(score >= 20) { qText = "ğŸ’ ÙÙˆÙ‚â€ŒØ§Ù„Ø¹Ø§Ø¯Ù‡"; color="#8e44ad"; launchConfetti(); }
            else if(score >= 16) { qText = "ğŸ¥‡ Ø®ÛŒÙ„ÛŒ Ø®ÙˆØ¨"; color="#2ecc71"; }
            else if(score >= 12) { qText = "ğŸ™‚ Ø®ÙˆØ¨"; color="#2980b9"; }
            else if(score >= 8) { qText = "âš ï¸ Ù‚Ø§Ø¨Ù„ Ù‚Ø¨ÙˆÙ„"; color="#f1c40f"; }
            else { qText = "â›” Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªÙ„Ø§Ø´ Ø¨ÛŒØ´ØªØ±"; color="#c0392b"; }
            
            const qEl = document.getElementById('qualitativeScore');
            qEl.innerText = qText; qEl.style.color = color;
            document.getElementById('btnReview').style.display = 'block';
            document.getElementById('xpMsg').style.display = 'block';
        }

        function startReviewMode() {
            document.getElementById('reportCard').style.display = 'none';
            document.getElementById('reviewArea').style.display = 'block';
            renderReview(currentQuestions, userAnswers);
        }

        function goToReview(id) {
            window.location.href = `azmoon.html?mode=history_review&target=${id}`;
        }

        async function prepareReviewMode(targetId) {
            if(!targetId) return;
            document.getElementById('loading').innerText = "Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ù¾Ø§Ø³Ø®â€ŒØ¨Ø±Ú¯...";
            document.getElementById('loading').style.display = 'block';

            // Ú¯Ø±ÙØªÙ† Ø¯ÛŒØªØ§ÛŒ ØªØ§Ø²Ù‡ Ø§Ø² Ø³Ø±ÙˆØ±
            const resUser = await fetch(API_URL, { method: 'POST', headers: { "Content-Type": "application/json" }, body: JSON.stringify({ action: 'login', username: currentUser.username, password: currentUser.password }) });
            const userData = await resUser.json();
            RankSystem.init(userData.jsonData); 

            const resEx = await fetch(API_URL, { method: 'POST', headers: { "Content-Type": "application/json" }, body: JSON.stringify({ action: 'get_exams' }) });
            const eData = await resEx.json();

            // ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±Ú¯Øª Ø¨Ù‡ Ø±Ø´ØªÙ‡ Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù†
            const sTargetId = String(targetId);
            const myData = (RankSystem.data.exam_details || {})[sTargetId];
            const exam = eData.data.find(e => String(e.id) === sTargetId);

            if(exam && myData) {
                document.getElementById('lobby').style.display = 'none';
                document.getElementById('reviewArea').style.display = 'block';
                renderReview(exam.questions, myData.answers || {});
            } else { alert("Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¢Ø²Ù…ÙˆÙ† ÛŒØ§ÙØª Ù†Ø´Ø¯."); window.location.href = 'azmoon.html'; }
        }

        function renderReview(questions, answers) {
            const c = document.getElementById('reviewContent');
            c.innerHTML = '';
            questions.forEach((q, i) => {
                const uAns = answers[i];
                const isCorrect = (uAns == q.correct);
                let html = `<div class="review-q"><b>Ø³ÙˆØ§Ù„ ${i+1}:</b> ${q.q}`;
                if(q.img) html += `<br><img src="${q.img}" style="max-height:150px; margin:5px 0;">`;
                
                q.options.forEach((op, idx) => {
                    const val = idx+1;
                    let color = "#fff", border = "#eee";
                    if(val == q.correct) { color = "#d4edda"; border = "#c3e6cb"; } 
                    else if(val == uAns) { color = "#f8d7da"; border = "#f5c6cb"; } 
                    
                    let content = optIsImage(op) ? `<img src="${op}" style="max-height:100px; vertical-align:middle">` : op;
                    html += `<div style="background:${color}; border:1px solid ${border}; padding:10px; margin:5px 0; border-radius:10px;">${val}) ${content}</div>`;
                });
                
                if(q.desc) html += `<div style="background:#fff3cd; padding:10px; margin-top:10px; border-radius:8px; font-size:0.9rem;">ğŸ’¡ <b>ØªÙˆØ¶ÛŒØ­:</b> ${q.desc}</div>`;
                html += `</div>`;
                c.innerHTML += html;
            });
        }

        function optIsImage(s) { return s.startsWith('http') || s.startsWith('/uploads'); }
        function openLightbox(src) { document.getElementById('lightboxImg').src = src; document.getElementById('lightbox').style.display = 'flex'; }
        function launchConfetti() {
            const c = document.getElementById('confetti-canvas');
            const ctx = c.getContext('2d');
            c.width = window.innerWidth; c.height = window.innerHeight;
            const p = Array.from({length:100}, () => ({x:Math.random()*c.width, y:Math.random()*c.height-c.height, c:`hsl(${Math.random()*360},100%,50%)`, v:Math.random()*5+2}));
            function draw(){ctx.clearRect(0,0,c.width,c.height);p.forEach(k=>{k.y+=k.v;ctx.fillStyle=k.c;ctx.beginPath();ctx.arc(k.x,k.y,5,0,Math.PI*2);ctx.fill();if(k.y>c.height)k.y=0;});requestAnimationFrame(draw);}
            draw(); setTimeout(()=>c.style.display='none',3000);
        }

        window.onload = init;
    </script>
</body>
</html>
