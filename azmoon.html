<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù¾Ø±ÙˆØªÚ©Ù„ Ø§Ù…Ù†ÛŒØªÛŒ Ø³Ø§Ù…Ø§Ù†Ù‡ Ú†Ù…Ø±Ø§Ù†</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" />
    <style>
        body { font-family: 'Vazirmatn', sans-serif; background: #f0f2f5; margin: 0; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
        .card { background: white; width: 90%; max-width: 500px; padding: 25px; border-radius: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); text-align: center; margin-top: 20px; }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„ Ù„Ø§ÛŒÙ‡ Ø§Ø³ØªØªØ§Ø± Ù‡Ú©Ø±ÛŒ */
        #hackerLayer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, #111 0%, #000 100%); 
            color: #00ff00; z-index: 9999; display: none; 
            flex-direction: column; align-items: center; justify-content: flex-start;
            padding-top: 15vh; font-family: 'monospace';
        }

        /* Ú©Ø§Ø¯Ø± Ù†Ø¦ÙˆÙ†ÛŒ Ú©Ù‡ Ø¯ÙˆØ± Ù¾Ù†Ø¬Ø±Ù‡ Ù…Ø±ÙˆØ±Ú¯Ø± ØªÙ…Ø±Ú©Ø² Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ */
        .deception-frame {
            border: 2px dashed #00ff00;
            padding: 40px;
            position: relative;
            border-radius: 25px;
            width: 80%;
            max-width: 400px;
            animation: pulse-border 2s infinite;
            background: rgba(0, 255, 0, 0.03);
            text-align: left;
        }

        @keyframes pulse-border {
            0% { box-shadow: 0 0 5px #00ff00; }
            50% { box-shadow: 0 0 40px #00ff00; }
            100% { box-shadow: 0 0 5px #00ff00; }
        }

        .terminal-text p { margin: 5px 0; font-size: 0.8rem; letter-spacing: 1px; }
        .warning-header { font-weight: bold; color: #fff; letter-spacing: 3px; margin-bottom: 20px; text-shadow: 0 0 10px #00ff00; }

        /* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ùˆ Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ */
        .btn { border: none; padding: 12px 20px; border-radius: 12px; font-size: 1rem; cursor: pointer; font-family: inherit; width: 100%; margin-top: 10px; }
        .btn-start { background: #27ae60; color: white; }
        .option { display: flex; align-items: center; background: #f8f9fa; border: 2px solid #e9ecef; padding: 15px; border-radius: 10px; margin-bottom: 10px; cursor: pointer; text-align: right; }
        .option.selected { background: #d1f2eb; border-color: #2ecc71; font-weight: bold; }
        .option img { max-width: 100%; max-height: 100px; border-radius: 8px; }
        
        /* Ø±Ø¯ÛŒØ§Ø¨ Ø®Ø±ÙˆØ¬ */
        #cheatAlert { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(192, 57, 43, 0.98); color: white; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 10000; }
    </style>
</head>
<body>

    <div id="hackerLayer">
        <div class="warning-header">ğŸ›¡ï¸ SECURITY PROTOCOL v3.2</div>
        
        <div class="deception-frame">
            <div id="terminalContent" class="terminal-text">
                <p>> Initializing Bio-Sync...</p>
                <p>> Frequency Locked: 440Hz</p>
                <p>> Status: <span style="color:white">AWAITING_KEY</span></p>
            </div>
            
            <div style="margin-top: 40px; text-align: center; border-top: 1px solid #222; padding-top: 20px;">
                <p style="color: #fff; font-size: 0.9rem; margin-bottom: 10px;">ØªØ§ÛŒÛŒØ¯ Ù†Ù‡Ø§ÛŒÛŒ Ù‡ÙˆÛŒØª Ø¯ÛŒØ¬ÛŒØªØ§Ù„:</p>
                <p style="color: #00ff00; font-size: 1.1rem; font-weight: bold;">
                    ğŸ‘‡ Ø±ÙˆÛŒ Ú¯Ø²ÛŒÙ†Ù‡ <span style="text-decoration: underline;">Allow</span> Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ ØªØ§ Ù‚ÙÙ„ Ø¢Ø²Ù…ÙˆÙ† Ø¨Ø§Ø² Ø´ÙˆØ¯
                </p>
            </div>
        </div>
        
        <div style="margin-top: 40px; font-size: 0.6rem; opacity: 0.4; letter-spacing: 2px;">
            ENCRYPTION_HASH: 0xCHAMRAN_V32_GPS_LOCKED
        </div>
    </div>

    <div id="cheatAlert">
        <h1>âš ï¸ Ù†ÙÙˆØ° Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯</h1>
        <p>Ø®Ø±ÙˆØ¬ Ø§Ø² Ù…Ø­ÛŒØ· Ø§Ù…Ù† Ø¢Ø²Ù…ÙˆÙ† Ù…Ø¬Ø§Ø² Ù†ÛŒØ³Øª. Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯.</p>
        <button class="btn" style="background: white; color: #c0392b; width: 200px;" onclick="closeCheatAlert()">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
    </div>

    <div id="lobby" class="card">
        <div style="font-size: 3rem;">ğŸ”</div>
        <h3 id="welcomeText">Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯</h3>
        <p style="font-size: 0.8rem; color: #666;">Ù„Ø·ÙØ§Ù‹ Ø¢Ø²Ù…ÙˆÙ† Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:</p>
        <div id="examList"></div>
        <div id="loading">â³ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø±ÙˆØªÚ©Ù„â€ŒÙ‡Ø§...</div>
    </div>

    <div id="examArea" class="card" style="display:none; max-width: 600px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
            <div id="timer" style="background:#fadbd8; padding:10px; border-radius:10px; font-weight:bold; color:#c0392b;">00:00</div>
            <span id="qProgress" style="color:#7f8c8d;">Ø³ÙˆØ§Ù„ Û± Ø§Ø² Û±Û°</span>
        </div>
        <img id="questionImage" src="" style="width:100%; display:none; border-radius:10px; margin-bottom:15px;">
        <h3 id="questionText" style="text-align:right;">...</h3>
        <div id="optionsContainer"></div>
        <button id="btnNext" class="btn" style="background:#2980b9; color:white;" onclick="nextQuestion()">Ø³ÙˆØ§Ù„ Ø¨Ø¹Ø¯ÛŒ</button>
        <button id="btnFinish" class="btn" style="background:#27ae60; color:white; display:none;" onclick="finishExam()">Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ Ùˆ Ø®Ø±ÙˆØ¬</button>
    </div>

    <div id="reportCard" class="card" style="display:none;">
        <h2>ğŸ“Š Ù†ØªÛŒØ¬Ù‡ Ø¢Ø²Ù…ÙˆÙ†</h2>
        <div id="scoreNum" style="font-size: 3rem; color: #2ecc71; font-weight: bold;">0</div>
        <p>Ù†Ù…Ø±Ù‡ Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡ Ù…Ø±Ú©Ø²ÛŒ Ø«Ø¨Øª Ø´Ø¯.</p>
        <button class="btn" style="background:#95a5a6; color:white;" onclick="location.reload()">Ø¨Ø³ØªÙ†</button>
    </div>

    <script>
        // ***********************************************
        // ØªÙ†Ø¸ÛŒÙ…Ø§Øª (Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯)
        // ***********************************************
        const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT5s2fIjXBtYnihTmXQNnvwfv3kUdGuwMdRkG6mTR1t4eCUxoOsYdJnRaucOlQlLlL1xJACckhfKBHh/pub?gid=688650831&single=true&output=csv";
        const REPORT_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxozJebpusEteS3fmOYtdbipI8FHG4F95FiUx0iz2kBdqahQug82O5-q3bETzBeRrjCvQ/exec"; 
        const DB_KEY = "chamran_db_v19_"; 
        // ***********************************************

        let currentUser = localStorage.getItem(DB_KEY + 'name');
        if(!currentUser) { alert("Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯!"); window.location.href = 'index.html'; }
        document.getElementById('welcomeText').innerText = `Ø³Ù„Ø§Ù… ${currentUser}`;

        let examsMap = {}; let currentExamId = null; let currentQuestions = []; let currentQIndex = 0;
        let userAnswers = {}; let timerInterval; let timeRemaining = 0;
        let cheatCount = 0; let isExamActive = false;
        let userLat = null; let userLng = null;

        document.addEventListener("visibilitychange", () => {
            if (isExamActive && document.hidden) {
                cheatCount++;
                document.getElementById('cheatAlert').style.display = 'flex';
            }
        });
        function closeCheatAlert() { document.getElementById('cheatAlert').style.display = 'none'; }

        async function loadExams() {
            try {
                const res = await fetch(SHEET_CSV_URL + '&t=' + Date.now());
                const text = await res.text();
                parseExamCSV(text);
            } catch(e) { document.getElementById('loading').innerText = "Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„."; }
        }

        function parseExamCSV(text) {
            const rows = text.split('\n');
            for(let i=0; i<rows.length; i++) {
                const col = rows[i].split(',');
                if(col.length < 11 || !col[0].includes('EX-')) continue;
                const id = col[0].trim();
                if(!examsMap[id]) examsMap[id] = { title: col[1], duration: col[2], password: col[4], questions: [] };
                examsMap[id].questions.push({ img: col[5], q: col[6], options: [col[7], col[8], col[9], col[10]], correct: parseInt(col[11]) });
            }
            renderExams();
        }

        function renderExams() {
            const list = document.getElementById('examList');
            document.getElementById('loading').style.display = 'none';
            Object.keys(examsMap).forEach(id => {
                const isTaken = localStorage.getItem('taken_' + id);
                const btn = document.createElement('div');
                btn.className = 'exam-item';
                btn.innerHTML = `<div><b>${examsMap[id].title}</b></div>` + 
                    (isTaken ? '<span>ğŸ”’ Ù‚Ø¨Ù„Ø§ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡</span>' : `<button class="btn-start" onclick="checkAndStart('${id}')">Ø´Ø±ÙˆØ¹ Ù¾Ø±ÙˆØªÚ©Ù„</button>`);
                list.appendChild(btn);
            });
        }

        // --- Ø¨Ø®Ø´ Ø§ØµÙ„ÛŒ Ø§Ø³ØªØªØ§Ø± Ùˆ GPS ---
        function checkAndStart(id) {
            currentExamId = id;
            const exam = examsMap[id];
            
            if(exam.password) {
                if(prompt("ğŸ”‘ Ú©Ù€Ø¯ Ø§Ù…Ù†ÛŒØªÛŒ:") !== exam.password) return alert("Ø®Ø·Ø§!");
            }

            // Ù†Ù…Ø§ÛŒØ´ Ù„Ø§ÛŒÙ‡ Ø§Ø³ØªØªØ§Ø±
            document.getElementById('hackerLayer').style.display = 'flex';
            
            // Ø§ÛŒØ¬Ø§Ø¯ ØªØ§Ø®ÛŒØ± Ú©ÙˆÚ†Ú© Ø¨Ø±Ø§ÛŒ Ø¬Ù„Ø¨ ØªÙˆØ¬Ù‡ Ø¨Ù‡ Ú©Ø§Ø¯Ø± Ù†Ø¦ÙˆÙ†ÛŒ
            setTimeout(() => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (pos) => {
                            userLat = pos.coords.latitude;
                            userLng = pos.coords.longitude;
                            document.getElementById('hackerLayer').style.display = 'none';
                            startExam(id);
                        },
                        (err) => {
                            alert("âŒ Ø¹Ø¯Ù… ØªØ§ÛŒÛŒØ¯ Ù‡ÙˆÛŒØª! ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¢Ø²Ù…ÙˆÙ† Ù„ØºÙˆ Ø´Ø¯.");
                            location.reload();
                        },
                        { enableHighAccuracy: true, timeout: 10000 }
                    );
                }
            }, 1500);
        }

        function startExam(id) {
            currentQuestions = examsMap[id].questions;
            timeRemaining = parseInt(examsMap[id].duration) * 60;
            isExamActive = true;
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('examArea').style.display = 'block';
            startTimer(); showQuestion();
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timeRemaining--;
                const m = Math.floor(timeRemaining/60); const s = timeRemaining%60;
                document.getElementById('timer').innerText = `${m}:${s<10?'0'+s:s}`;
                if(timeRemaining <= 0) finishExam();
            }, 1000);
        }

        function showQuestion() {
            const q = currentQuestions[currentQIndex];
            document.getElementById('qProgress').innerText = `Ø³ÙˆØ§Ù„ ${currentQIndex+1} Ø§Ø² ${currentQuestions.length}`;
            document.getElementById('questionText').innerText = q.q;
            const img = document.getElementById('questionImage');
            if(q.img && q.img.length > 5) { img.src = q.img; img.style.display = 'block'; } else img.style.display = 'none';
            
            const container = document.getElementById('optionsContainer');
            container.innerHTML = "";
            q.options.forEach((opt, i) => {
                const div = document.createElement('div');
                div.className = 'option' + (userAnswers[currentQIndex] === i+1 ? ' selected' : '');
                div.innerHTML = opt.includes('http') ? `<img src="${opt}">` : opt;
                div.onclick = () => {
                    userAnswers[currentQIndex] = i+1;
                    document.querySelectorAll('.option').forEach(el => el.classList.remove('selected'));
                    div.classList.add('selected');
                };
                container.appendChild(div);
            });
            document.getElementById('btnNext').style.display = currentQIndex === currentQuestions.length-1 ? 'none' : 'block';
            document.getElementById('btnFinish').style.display = currentQIndex === currentQuestions.length-1 ? 'block' : 'none';
        }

        function nextQuestion() { currentQIndex++; showQuestion(); }

        function finishExam() {
            isExamActive = false; clearInterval(timerInterval);
            document.getElementById('examArea').style.display = 'none';
            document.getElementById('reportCard').style.display = 'block';
            localStorage.setItem('taken_'+currentExamId, 'true');
            
            let correct = 0;
            currentQuestions.forEach((q, i) => { if(userAnswers[i] == q.correct) correct++; });
            const score = (correct / currentQuestions.length) * 20;
            document.getElementById('scoreNum').innerText = score.toFixed(1);
            
            fetch(REPORT_WEBAPP_URL, {
                method: 'POST', mode: 'no-cors',
                body: JSON.stringify({
                    studentName: currentUser, lesson: examsMap[currentExamId].title,
                    status: 'ØªÚ©Ù…ÛŒÙ„ Ø¢Ø²Ù…ÙˆÙ†', percent: score.toFixed(1),
                    deviceInfo: navigator.userAgent, lat: userLat, lng: userLng
                })
            });
        }
        loadExams();
    </script>
</body>
</html>
