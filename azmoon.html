<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø³Ø§Ù„Ù† Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ú†Ù…Ø±Ø§Ù† (Ù†Ø³Ø®Ù‡ Ø§Ø¨Ø±ÛŒ â˜ï¸)</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" />
    <style>
        :root { --primary: #2c3e50; --accent: #8e44ad; --bg: #f0f2f5; --success: #27ae60; --danger: #c0392b; --warning: #f1c40f; }
        body { font-family: 'Vazirmatn', sans-serif; background: var(--bg); margin: 0; padding: 15px; min-height: 100vh; display: flex; flex-direction: column; align-items: center; user-select: none; -webkit-tap-highlight-color: transparent; }

        /* Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ */
        .card { background: white; width: 100%; max-width: 600px; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); margin-bottom: 20px; text-align: center; animation: fadeIn 0.5s; position: relative; overflow: hidden; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ */
        .btn { border: none; padding: 14px; border-radius: 12px; font-size: 1rem; cursor: pointer; font-family: inherit; width: 100%; font-weight: bold; transition: 0.2s; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:active { transform: scale(0.98); }
        .btn-start { background: var(--accent); color: white; box-shadow: 0 4px 15px rgba(142, 68, 173, 0.3); }
        .btn-next { background: #2980b9; color: white; }
        .btn-finish { background: var(--success); color: white; display: none; }
        .btn-back { background: #ecf0f1; color: #2c3e50; }
        
        /* Ù„ÛŒØ³Øª Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§ */
        .exam-item { background: #fff; border: 2px solid #e1bee7; border-radius: 16px; padding: 15px; margin-bottom: 12px; text-align: right; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; position: relative; }
        .exam-item:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .exam-item.locked { background: #f8f9fa; border-color: #bdc3c7; opacity: 0.8; }
        .exam-info h4 { margin: 0; color: #4a148c; font-size: 1rem; }
        .exam-info small { color: #7f8c8d; font-size: 0.8rem; display: block; margin-top: 5px; }
        
        /* ØªØ§ÛŒÙ…Ø± */
        .timer-box { font-size: 1.5rem; font-weight: bold; color: var(--danger); background: #fadbd8; padding: 5px 15px; border-radius: 12px; display: inline-block; box-shadow: 0 4px 10px rgba(192, 57, 43, 0.2); }

        /* ØªØµØ§ÙˆÛŒØ± Ùˆ Ù„Ø§ÛŒØªâ€ŒØ¨Ø§Ú©Ø³ */
        .q-image { width: 100%; max-height: 250px; object-fit: contain; border-radius: 12px; border: 1px solid #eee; margin: 10px 0; cursor: zoom-in; transition: 0.2s; background: #fafafa; }
        .q-image:hover { border-color: var(--accent); }
        
        #lightbox { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: none; justify-content: center; align-items: center; cursor: zoom-out; backdrop-filter: blur(5px); }
        #lightbox img { max-width: 95%; max-height: 95%; border-radius: 10px; box-shadow: 0 0 50px rgba(255,255,255,0.2); animation: zoomIn 0.3s; }
        @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ */
        .option { background: #f8f9fa; border: 2px solid #e9ecef; padding: 15px; border-radius: 12px; margin-bottom: 10px; cursor: pointer; text-align: right; transition: 0.2s; display: flex; align-items: center; }
        .option:hover { border-color: #b2bec3; }
        .option.selected { background: #e8f6f3; border-color: var(--success); color: var(--success); font-weight: bold; box-shadow: 0 4px 10px rgba(39, 174, 96, 0.2); transform: scale(1.02); }
        .option img { max-width: 80px; max-height: 80px; border-radius: 8px; margin-right: 10px; border: 1px solid #ddd; }

        /* Ù†ÙˆØ§Ø± Ù†Ù…Ø±Ù‡ Ø¬Ø¯ÛŒØ¯ (Ø®ÙˆØ§Ù†Ø§) */
        .score-wrapper { margin: 30px 0; background: #ecf0f1; border-radius: 15px; height: 30px; position: relative; overflow: hidden; box-shadow: inset 0 2px 5px rgba(0,0,0,0.1); }
        .score-fill { height: 100%; background: linear-gradient(90deg, #e74c3c, #f1c40f, #2ecc71); width: 0%; transition: width 1.5s cubic-bezier(0.25, 1, 0.5, 1); border-radius: 15px; position: relative; }
        .score-fill::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(45deg, rgba(255,255,255,0.2) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0.2) 75%, transparent 75%, transparent); background-size: 20px 20px; animation: moveStripe 1s linear infinite; }
        @keyframes moveStripe { 0% { background-position: 0 0; } 100% { background-position: 20px 20px; } }
        
        .score-badge-large { font-size: 3rem; font-weight: bold; margin: 10px 0; display: block; text-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        /* ØªØ§Ø±ÛŒØ®Ú†Ù‡ */
        .history-grid { display: grid; gap: 10px; }
        .hist-item { background: white; border: 1px solid #eee; padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; }
        .hist-score { background: #2c3e50; color: white; padding: 5px 12px; border-radius: 10px; font-weight: bold; font-size: 0.9rem; }

        #loading { color: #7f8c8d; font-weight: bold; margin-top: 20px; }
        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9998; }
    </style>
</head>
<body>

    <canvas id="confetti-canvas"></canvas>

    <div id="lightbox" onclick="this.style.display='none'">
        <img id="lightboxImg" src="">
    </div>

    <div id="lobby" class="card">
        <div style="font-size: 3.5rem; margin-bottom: 5px;">ğŸ“</div>
        <h2 id="welcomeText" style="margin:0 0 10px 0;">Ø³Ø§Ù„Ù† Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</h2>
        <div id="loading">â³ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±...</div>
        
        <div id="resumeAlert" style="display:none; background:#fff3cd; color:#856404; padding:12px; border-radius:12px; margin-bottom:15px; border:1px solid #ffeeba;">
            âš ï¸ ÛŒÚ© Ø¢Ø²Ù…ÙˆÙ† Ù†Ø§ØªÙ…Ø§Ù… Ø¯Ø§Ø±ÛŒØ¯! Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª...
        </div>

        <div id="examList"></div>
        <button class="btn btn-back" onclick="window.location.href='index.html'">ğŸ  Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø®Ø§Ù†Ù‡</button>
    </div>

    <div id="examArea" class="card" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #f1f2f6; padding-bottom: 10px;">
            <span id="qProgress" style="font-weight:bold; color:var(--primary);">Ø³ÙˆØ§Ù„ Û±</span>
            <div id="timer" class="timer-box">00:00</div>
        </div>

        <img id="questionImage" class="q-image" src="" onclick="openLightbox(this.src)" style="display:none;">
        <h3 id="questionText" style="text-align: right; line-height: 1.8; font-size: 1.1rem; color: #34495e;">...</h3>
        
        <div id="optionsContainer"></div>

        <button id="btnNext" class="btn btn-next" onclick="nextQuestion()">Ø³ÙˆØ§Ù„ Ø¨Ø¹Ø¯ÛŒ â¬…ï¸</button>
        <button id="btnFinish" class="btn btn-finish" onclick="finishExam()">âœ… Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ Ø¢Ø²Ù…ÙˆÙ†</button>
    </div>

    <div id="reportCard" class="card" style="display: none;">
        <h2 style="color:var(--accent);">ğŸ“Š Ù†ØªÛŒØ¬Ù‡ Ø¹Ù…Ù„Ú©Ø±Ø¯</h2>
        <h4 id="reportTitle" style="color:#7f8c8d; margin-top:0;"></h4>
        
        <div id="finalScoreBadge" class="score-badge-large">0</div>
        
        <div class="score-wrapper">
            <div id="scoreFill" class="score-fill"></div>
        </div>
        <div id="qualitativeScore" style="font-weight:bold; font-size:1.2rem; margin-bottom:20px;">...</div>

        <div id="xpMsg" style="background:#e8f6f3; color:#16a085; padding:10px; border-radius:10px; margin-bottom:15px; display:none;">
            Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø± Ø³Ø±ÙˆØ± Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ â˜ï¸
        </div>

        <button id="btnReview" class="btn" style="background:#f39c12; color:white; display:none;" onclick="startReviewMode()">ğŸ” ØªØ­Ù„ÛŒÙ„ Ùˆ Ù…Ø±ÙˆØ± Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§</button>
        <button class="btn btn-back" onclick="location.reload()">Ù„ÛŒØ³Øª Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§</button>
    </div>

    <div id="reviewArea" class="card" style="display: none; text-align: right;">
        <h3 style="text-align:center; color:#e67e22; border-bottom:2px solid #eee; padding-bottom:10px;">ğŸ§ ØªØ­Ù„ÛŒÙ„ Ø¢Ø²Ù…ÙˆÙ†</h3>
        <div id="reviewContent"></div>
        <button class="btn btn-back" onclick="location.reload()">Ù¾Ø§ÛŒØ§Ù† Ù…Ø±ÙˆØ±</button>
    </div>

    <script src="rank.js"></script>
    <script>
        const API_URL = "https://chamran-api.liara.run"; 
        const EXAM_STATE_KEY = "chamran_exam_active_session_v3"; // Ú©Ù„ÛŒØ¯ Ø°Ø®ÛŒØ±Ù‡ Ù…ÙˆÙ‚Øª
        
        let currentUser = null;
        let examsMap = {};
        let currentExamId = null;
        let currentQuestions = [];
        let currentQIndex = 0;
        let userAnswers = {};
        let timerInterval;
        let timeRemaining = 0;
        let isReviewMode = false;

        // --- 1. Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ùˆ Ù„ÙˆØ¯ Ø¯ÛŒØªØ§ Ø§Ø² Ø³Ø±ÙˆØ± ---
        function init() {
            const savedUser = localStorage.getItem('chamran_db_vfinal_creds');
            if(!savedUser) { window.location.href = 'index.html'; return; }
            
            try {
                currentUser = JSON.parse(savedUser);
                document.getElementById('welcomeText').innerText = `Ø³Ù„Ø§Ù… ${currentUser.displayName}`;
                
                // Ø³ÛŒÙ†Ú© Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø§ Ø³Ø±ÙˆØ± Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø¢Ø®Ø±ÛŒÙ† ÙˆØ¶Ø¹ÛŒØª
                SyncManager.init(currentUser.username, currentUser.password);
                performFullSync(); 

                // Ú†Ú© Ú©Ø±Ø¯Ù† Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø±Ø§ÛŒ Ù…Ø±ÙˆØ± ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¢Ù…Ø¯Ù‡ØŸ
                const urlParams = new URLSearchParams(window.location.search);
                if(urlParams.get('mode') === 'history_review') {
                    prepareReviewMode();
                } else {
                    checkActiveSession(); // Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø¢Ø²Ù…ÙˆÙ† Ù†Ø§ØªÙ…Ø§Ù…
                }
            } catch(e) { window.location.href = 'index.html'; }
        }

        async function performFullSync() {
            // Ø¯Ø±ÛŒØ§ÙØª Ø¢Ø®Ø±ÛŒÙ† Ø¯ÛŒØªØ§ÛŒ Ú©Ø§Ø±Ø¨Ø± + Ù„ÛŒØ³Øª Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§ Ø§Ø² Ø³Ø±ÙˆØ±
            try {
                const res = await fetch(API_URL, {
                    method: 'POST', headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ action: 'login', username: currentUser.username, password: currentUser.password })
                });
                const userData = await res.json();
                
                const resExams = await fetch(API_URL, {
                    method: 'POST', headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ action: 'get_exams' })
                });
                const examData = await resExams.json();

                if(userData.status === 'success' && examData.status === 'success') {
                    RankSystem.init(userData.jsonData); // Ø¢Ù¾Ø¯ÛŒØª Ø±Ù†Ú© Ø³ÛŒØ³ØªÙ… Ø¨Ø§ Ø¯ÛŒØªØ§ÛŒ Ø³Ø±ÙˆØ±
                    processExams(examData.data);
                } else { throw new Error("Server Error"); }
            } catch(e) {
                document.getElementById('loading').innerHTML = `<span style="color:red">âŒ Ø¹Ø¯Ù… Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±. Ù„Ø·ÙØ§ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø±Ø§ Ú†Ú© Ú©Ù†ÛŒØ¯.</span>`;
            }
        }

        function processExams(list) {
            examsMap = {};
            const container = document.getElementById('examList');
            container.innerHTML = '';
            document.getElementById('loading').style.display = 'none';

            list.reverse().forEach(ex => {
                examsMap[ex.id] = ex;
                
                // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø¢Ø²Ù…ÙˆÙ† Ø¯Ø± Ø¯ÛŒØªØ§ÛŒ Ø³Ø±ÙˆØ± (RankSystem)
                // Ø§ÛŒÙ† Ø®Ø· ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒ Ø¨Ù‡ Ù„ÙˆÚ©Ø§Ù„ Ø§Ø³ØªÙˆØ±ÛŒØ¬ Ø±Ø§ Ø­Ø°Ù Ù…ÛŒâ€ŒÚ©Ù†Ø¯
                const userExams = RankSystem.data.exams || {};
                const score = userExams[ex.id]; // Ø§Ú¯Ø± Ù†Ù…Ø±Ù‡ Ø¨Ø§Ø´Ø¯ ÛŒØ¹Ù†ÛŒ Ø´Ø±Ú©Øª Ú©Ø±Ø¯Ù‡
                const isTaken = (score !== undefined);

                const div = document.createElement('div');
                div.className = `exam-item ${isTaken ? 'locked' : ''}`;
                
                let btnHtml = '';
                if(isTaken) {
                    // Ù†Ù…Ø§ÛŒØ´ Ù†Ù…Ø±Ù‡ Ùˆ Ø¯Ú©Ù…Ù‡ Ù…Ø±ÙˆØ± (Ø§Ø² Ø³Ø±ÙˆØ±)
                    const color = score >= 15 ? '#27ae60' : (score < 10 ? '#c0392b' : '#f39c12');
                    btnHtml = `
                        <div style="text-align:left;">
                            <span style="font-weight:bold; color:${color}; font-size:1.1rem;">Ù†Ù…Ø±Ù‡: ${score}</span>
                            <br>
                            <button onclick="goToReview('${ex.id}')" style="background:none; border:none; color:#2980b9; cursor:pointer; font-size:0.8rem; padding:0;">ğŸ” Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù¾Ø§Ø³Ø®â€ŒØ¨Ø±Ú¯</button>
                        </div>`;
                } else {
                    const lockIcon = (ex.pass) ? 'ğŸ”’ ' : '';
                    btnHtml = `<button class="btn" style="width:auto; padding:5px 15px; font-size:0.9rem; background:var(--accent); color:white;" onclick="checkStart('${ex.id}')">${lockIcon}Ø´Ø±ÙˆØ¹</button>`;
                }

                div.innerHTML = `
                    <div class="exam-info">
                        <h4>${ex.title} ${ex.is_new ? '<span style="background:red; color:white; font-size:0.6rem; padding:2px 5px; border-radius:4px;">Ø¬Ø¯ÛŒØ¯</span>' : ''}</h4>
                        <small>â±ï¸ ${ex.time} Ø¯Ù‚ÛŒÙ‚Ù‡ | ${ex.questions.length} Ø³ÙˆØ§Ù„</small>
                    </div>
                    ${btnHtml}
                `;
                container.appendChild(div);
            });
        }

        // --- 2. Ù…Ø¯ÛŒØ±ÛŒØª Ø¢Ø²Ù…ÙˆÙ† (Ø´Ø±ÙˆØ¹ØŒ ØªØ§ÛŒÙ…Ø±ØŒ Ø³ÙˆØ§Ù„Ø§Øª) ---
        function checkStart(id) {
            const ex = examsMap[id];
            if(ex.pass) {
                const p = prompt("ğŸ”’ Ø±Ù…Ø² Ø¢Ø²Ù…ÙˆÙ† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:");
                if(p !== ex.pass) return alert("âŒ Ø±Ù…Ø² Ù†Ø§Ø¯Ø±Ø³Øª Ø§Ø³Øª");
            }
            if(confirm(`Ø¢Ø²Ù…ÙˆÙ† "${ex.title}" Ø¢ØºØ§Ø² Ø´ÙˆØ¯ØŸ\nâš ï¸ Ø²Ù…Ø§Ù†: ${ex.time} Ø¯Ù‚ÛŒÙ‚Ù‡`)) {
                startExam(id);
            }
        }

        function startExam(id) {
            const ex = examsMap[id];
            currentExamId = id;
            currentQuestions = ex.questions;
            currentQIndex = 0;
            userAnswers = {};
            
            // ØªÙ†Ø¸ÛŒÙ… Ø²Ù…Ø§Ù† (Ø°Ø®ÛŒØ±Ù‡ Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹ Ø¯Ø± Ù„ÙˆÚ©Ø§Ù„ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø±ÛŒØ³Øª Ø¨Ø§ Ø±ÙØ±Ø´)
            // Ø§Ù…Ø§ Ø§Ø¹ØªØ¨Ø§Ø± Ø³Ù†Ø¬ÛŒ Ø§ØµÙ„ÛŒ Ø³Ù…Øª Ø³Ø±ÙˆØ± Ù†ÛŒØ³Øª (Ú†ÙˆÙ† Ø³ÙˆÚ©Øª Ù†Ø¯Ø§Ø±ÛŒÙ…)ØŒ ÙˆÙ„ÛŒ Ø§ÛŒÙ† Ø±ÙˆØ´ 99% Ø¬Ù„ÙˆÛŒ Ø±ÙØ±Ø´ Ø±Ø§ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯
            const now = Math.floor(Date.now() / 1000);
            const durationSec = parseInt(ex.time) * 60;
            
            const session = { id: id, start: now, end: now + durationSec, questions: ex.questions };
            localStorage.setItem(EXAM_STATE_KEY, JSON.stringify(session));
            
            timeRemaining = durationSec;
            showExamUI();
            
            // Ú¯Ø²Ø§Ø±Ø´ Ø´Ø±ÙˆØ¹ Ø¨Ù‡ Ø³Ø±ÙˆØ±
            SyncManager.addToQueue('report', { lesson: `Ø¢Ø²Ù…ÙˆÙ†: ${ex.title}`, status: 'Ø´Ø±ÙˆØ¹', details: 'ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¬Ù„Ø³Ù‡' });
        }

        function checkActiveSession() {
            const saved = localStorage.getItem(EXAM_STATE_KEY);
            if(saved) {
                try {
                    const session = JSON.parse(saved);
                    const now = Math.floor(Date.now() / 1000);
                    const remaining = session.end - now;

                    if(remaining > 0) {
                        // Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø¬Ù„Ø³Ù‡
                        document.getElementById('resumeAlert').style.display = 'block';
                        setTimeout(() => {
                            currentExamId = session.id;
                            currentQuestions = session.questions;
                            currentQIndex = 0; // ÙØ¹Ù„Ø§ Ø§Ø² Ø§ÙˆÙ„ (ÛŒØ§ Ù…ÛŒØªÙˆÙ†ÛŒÙ… Ø§ÛŒÙ†Ù… Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒÙ…)
                            timeRemaining = remaining;
                            userAnswers = {}; // Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ Ù…ÛŒÙ¾Ø±Ø¯ Ù…Ú¯Ø± Ø§ÛŒÙ†Ú©Ù‡ Ø¯Ø± Ù‡Ø± Ø³ÙˆØ§Ù„ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒÙ… (Ø§ÛŒÙ†Ø¬Ø§ Ø³Ø§Ø¯Ù‡ Ú¯Ø±ÙØªÛŒÙ…)
                            showExamUI();
                        }, 1500);
                    } else {
                        // Ø²Ù…Ø§Ù† ØªÙ…Ø§Ù… Ø´Ø¯Ù‡ Ø¯Ø± ØºÛŒØ§Ø¨ Ú©Ø§Ø±Ø¨Ø±
                        localStorage.removeItem(EXAM_STATE_KEY);
                        alert("â° Ø²Ù…Ø§Ù† Ø¢Ø²Ù…ÙˆÙ† Ù‚Ø¨Ù„ÛŒ Ø´Ù…Ø§ Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯Ù‡ Ø§Ø³Øª.");
                    }
                } catch(e) { localStorage.removeItem(EXAM_STATE_KEY); }
            }
        }

        function showExamUI() {
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('examArea').style.display = 'block';
            startTimer();
            loadQuestion();
        }

        function startTimer() {
            clearInterval(timerInterval);
            const display = document.getElementById('timer');
            timerInterval = setInterval(() => {
                timeRemaining--;
                const m = Math.floor(timeRemaining / 60);
                const s = timeRemaining % 60;
                display.innerText = `${m}:${s < 10 ? '0'+s : s}`;
                
                if(timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    alert("â° Ø²Ù…Ø§Ù† ØªÙ…Ø§Ù… Ø´Ø¯! Ø¨Ø±Ú¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø§Ù„Ø§.");
                    finishExam(true);
                }
            }, 1000);
        }

        function loadQuestion() {
            const q = currentQuestions[currentQIndex];
            document.getElementById('qProgress').innerText = `Ø³ÙˆØ§Ù„ ${currentQIndex+1} Ø§Ø² ${currentQuestions.length}`;
            
            // Ù†Ù…Ø§ÛŒØ´ Ù…ØªÙ†
            document.getElementById('questionText').innerText = q.q;
            
            // Ù†Ù…Ø§ÛŒØ´ ØªØµÙˆÛŒØ± Ø¨Ø§ Ù„Ø§ÛŒØª Ø¨Ø§Ú©Ø³
            const imgEl = document.getElementById('questionImage');
            if(q.img && q.img.length > 3) {
                imgEl.src = q.img;
                imgEl.style.display = 'block';
            } else { imgEl.style.display = 'none'; }

            // Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§
            const cont = document.getElementById('optionsContainer');
            cont.innerHTML = '';
            
            q.options.forEach((opt, idx) => {
                const val = idx + 1;
                const div = document.createElement('div');
                div.className = `option ${userAnswers[currentQIndex] === val ? 'selected' : ''}`;
                
                // ØªØ´Ø®ÛŒØµ Ø§ÛŒÙ†Ú©Ù‡ Ú¯Ø²ÛŒÙ†Ù‡ Ø¹Ú©Ø³ Ø§Ø³Øª ÛŒØ§ Ù…ØªÙ†
                let content = opt;
                if(opt.startsWith('http') || opt.startsWith('/uploads')) {
                    content = `<img src="${opt}" onclick="event.stopPropagation(); openLightbox('${opt}')">`;
                }
                
                div.innerHTML = `<span style="font-weight:bold; color:#7f8c8d; margin-left:10px;">${val})</span> ${content}`;
                div.onclick = () => selectOption(val, div);
                cont.appendChild(div);
            });

            // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
            const isLast = currentQIndex === currentQuestions.length - 1;
            document.getElementById('btnNext').style.display = isLast ? 'none' : 'block';
            document.getElementById('btnFinish').style.display = isLast ? 'block' : 'none';
        }

        function selectOption(val, el) {
            document.querySelectorAll('.option').forEach(o => o.classList.remove('selected'));
            el.classList.add('selected');
            userAnswers[currentQIndex] = val;
        }

        function nextQuestion() { currentQIndex++; loadQuestion(); }

        // --- 3. Ù¾Ø§ÛŒØ§Ù† Ø¢Ø²Ù…ÙˆÙ† Ùˆ Ø«Ø¨Øª Ø¯Ø± Ø³Ø±ÙˆØ± ---
        function finishExam(forced = false) {
            clearInterval(timerInterval);
            localStorage.removeItem(EXAM_STATE_KEY); // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø³Ø´Ù† Ù…ÙˆÙ‚Øª

            // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù†Ù…Ø±Ù‡
            let correctCount = 0;
            let wrongIndices = [];
            currentQuestions.forEach((q, idx) => {
                if(userAnswers[idx] == q.correct) correctCount++;
                else wrongIndices.push(idx + 1);
            });

            const score20 = (correctCount / currentQuestions.length) * 20;
            const finalScore = parseFloat(score20.toFixed(1)); // Ù†Ù…Ø±Ù‡ Ù†Ù‡Ø§ÛŒÛŒ

            // Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ± (Ø¨Ø§ Ø³ÛŒØ³ØªÙ… ØµÙ Ú©Ù‡ Ø¯Ø± rank.js Ø§Ø³Øª)
            // Ù…Ù‡Ù…: Ù…Ø§ userAnswers Ø±Ø§ Ù‡Ù… Ù…ÛŒÙØ±Ø³ØªÛŒÙ… ØªØ§ Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø³Ø±ÙˆØ± Ø¨Ù…Ø§Ù†Ø¯
            SyncManager.addToQueue('claim_reward', {
                reward_type: 'exam',
                reward_id: currentExamId,
                exam_score: finalScore,
                wrong_list: wrongIndices,
                user_answers: userAnswers // ğŸŒŸ Ú©Ù„ÛŒØ¯ Ø­Ù„ Ù…Ø´Ú©Ù„ Ù…Ø±ÙˆØ± Ø¯Ø± Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø¯ÛŒÚ¯Ø±
            });
            
            // Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ø±Ù†Ø§Ù…Ù‡
            showReportCard(finalScore, correctCount, currentQuestions.length);
        }

        function showReportCard(score, correct, total) {
            document.getElementById('examArea').style.display = 'none';
            document.getElementById('reportCard').style.display = 'block';

            // Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ù†Ù…Ø±Ù‡
            let s = 0;
            const badge = document.getElementById('finalScoreBadge');
            const interval = setInterval(() => {
                s += 0.5;
                if(s >= score) { s = score; clearInterval(interval); document.getElementById('btnReview').style.display='block'; document.getElementById('xpMsg').style.display='block'; launchConfetti(); }
                badge.innerText = s;
                // ØªØºÛŒÛŒØ± Ø±Ù†Ú¯ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ù…Ø±Ù‡
                badge.style.color = s >= 15 ? '#27ae60' : (s < 10 ? '#c0392b' : '#f39c12');
            }, 30);

            // Ù¾Ø± Ø´Ø¯Ù† Ù†ÙˆØ§Ø±
            setTimeout(() => {
                const percent = (score / 20) * 100;
                document.getElementById('scoreFill').style.width = percent + '%';
            }, 100);

            // Ù…ØªÙ† Ú©ÛŒÙÛŒ
            const qEl = document.getElementById('qualitativeScore');
            if(score === 20) { qEl.innerText = "ğŸ’ ÙÙˆÙ‚â€ŒØ§Ù„Ø¹Ø§Ø¯Ù‡ (Ù†Ø®Ø¨Ù‡)"; qEl.style.color = "#8e44ad"; }
            else if(score >= 17) { qEl.innerText = "ğŸ¥‡ Ø¹Ø§Ù„ÛŒ"; qEl.style.color = "#27ae60"; }
            else if(score >= 14) { qEl.innerText = "ğŸ™‚ Ø®ÙˆØ¨"; qEl.style.color = "#2980b9"; }
            else if(score >= 10) { qEl.innerText = "âš ï¸ Ù‚Ø§Ø¨Ù„ Ù‚Ø¨ÙˆÙ„"; qEl.style.color = "#f1c40f"; }
            else { qEl.innerText = "â›” Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªÙ„Ø§Ø´ Ø¨ÛŒØ´ØªØ±"; qEl.style.color = "#c0392b"; }
        }

        // --- 4. Ù…Ø±ÙˆØ± Ùˆ ØªØ§Ø±ÛŒØ®Ú†Ù‡ (Review) ---
        function goToReview(examId) {
            // Ù‡Ø¯Ø§ÛŒØª Ø¨Ù‡ ØµÙØ­Ù‡ Ø¨Ø§ Ù…ÙˆØ¯ ØªØ§Ø±ÛŒØ®Ú†Ù‡
            window.location.href = `azmoon.html?mode=history_review&target=${examId}`;
        }

        async function prepareReviewMode() {
            const urlParams = new URLSearchParams(window.location.search);
            const targetId = urlParams.get('target');
            if(!targetId) return;

            // Ø¯Ø±ÛŒØ§ÙØª Ø³ÙˆØ§Ù„Ø§Øª Ùˆ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± (Ø§Ø² Ø³Ø±ÙˆØ±)
            // Ú†ÙˆÙ† Ø¯Ø± init() Ø³ÛŒÙ†Ú© Ú©Ø§Ù…Ù„ Ú©Ø±Ø¯ÛŒÙ…ØŒ Ø§Ù„Ø§Ù† RankSystem.data Ø¢Ù¾Ø¯ÛŒØª Ø§Ø³Øª
            const userDetails = RankSystem.data.exam_details || {};
            const myData = userDetails[targetId];

            // Ø§Ú¯Ø± Ø¯ÛŒØªØ§ÛŒ Ù¾Ø§Ø³Ø®â€ŒØ¨Ø±Ú¯ Ø¯Ø± Ø³Ø±ÙˆØ± Ù†Ø¨ÙˆØ¯ (Ù…Ø«Ù„Ø§ Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ø®ÛŒÙ„ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ)
            if(!myData || !myData.answers) {
                alert("Ø¬Ø²Ø¦ÛŒØ§Øª Ù¾Ø§Ø³Ø®â€ŒØ¨Ø±Ú¯ Ø§ÛŒÙ† Ø¢Ø²Ù…ÙˆÙ† Ø¯Ø± Ø³Ø±ÙˆØ± Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª.");
                window.location.href = 'azmoon.html';
                return;
            }

            // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø³ÙˆØ§Ù„Ø§Øª Ø¢Ø²Ù…ÙˆÙ†
            // Ø´Ø§ÛŒØ¯ Ù„Ø§Ø²Ù… Ø¨Ø§Ø´Ø¯ Ù„ÛŒØ³Øª Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§ Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ú¯ÛŒØ±ÛŒÙ… Ø§Ú¯Ø± Ú©Ø´ Ù†Ø´Ø¯Ù‡ Ø¨ÙˆØ¯
            // Ø§Ù…Ø§ Ø¯Ø± init() Ù…Ø§ processExams Ú©Ø±Ø¯ÛŒÙ… Ù¾Ø³ examsMap Ù¾Ø± Ø§Ø³Øª.
            // ØµØ¨Ø± Ù…ÛŒÚ©Ù†ÛŒÙ… ØªØ§ examsMap Ù¾Ø± Ø´ÙˆØ¯ (Ú†ÙˆÙ† async Ø§Ø³Øª)
            setTimeout(() => {
                if(!examsMap[targetId]) { alert("Ø¢Ø²Ù…ÙˆÙ† ÛŒØ§ÙØª Ù†Ø´Ø¯"); return; }
                
                currentQuestions = examsMap[targetId].questions;
                userAnswers = myData.answers;
                
                document.getElementById('lobby').style.display = 'none';
                document.getElementById('reviewArea').style.display = 'block';
                renderReview();
            }, 1000);
        }

        function renderReview() {
            const cont = document.getElementById('reviewContent');
            cont.innerHTML = '';
            
            currentQuestions.forEach((q, idx) => {
                const uAns = userAnswers[idx];
                const cAns = q.correct;
                const isCorrect = (uAns == cAns);
                
                let statusIcon = isCorrect ? 'âœ…' : 'âŒ';
                if(!uAns) statusIcon = 'âšª'; // Ù†Ø²Ø¯Ù‡

                const div = document.createElement('div');
                div.style.borderBottom = "1px solid #eee";
                div.style.padding = "15px 0";
                
                // Ø±Ù†Ø¯Ø± Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´
                let opsHtml = '';
                q.options.forEach((op, i) => {
                    const val = i+1;
                    let style = "padding:5px; margin:2px 0; border-radius:5px;";
                    if(val == cAns) style += "background:#d4edda; color:#155724; border:1px solid #c3e6cb;"; // Ø³Ø¨Ø² Ø¨Ø±Ø§ÛŒ ØµØ­ÛŒØ­
                    else if(val == uAns && !isCorrect) style += "background:#f8d7da; color:#721c24; border:1px solid #f5c6cb;"; // Ù‚Ø±Ù…Ø² Ø¨Ø±Ø§ÛŒ ØºÙ„Ø· Ú©Ø§Ø±Ø¨Ø±
                    else style += "background:#f8f9fa; color:#777;";

                    opsHtml += `<div style="${style}">${val}) ${renderContent(op)}</div>`;
                });

                // ØªÙˆØ¶ÛŒØ­Ø§Øª Ø§Ø³ØªØ§Ø¯
                let descHtml = '';
                if(q.desc || q.desc_img) {
                    descHtml = `
                        <div style="background:#fff3cd; padding:10px; border-radius:8px; margin-top:5px; font-size:0.9rem;">
                            <strong>ğŸ’¡ ØªÙˆØ¶ÛŒØ­:</strong> ${q.desc || ''}
                            ${q.desc_img ? `<br><img src="${q.desc_img}" onclick="openLightbox(this.src)" style="max-height:100px; margin-top:5px; cursor:zoom-in;">` : ''}
                        </div>`;
                }

                div.innerHTML = `
                    <div style="font-weight:bold; margin-bottom:5px;">${statusIcon} Ø³ÙˆØ§Ù„ ${idx+1}</div>
                    <div style="margin-bottom:10px;">${q.q}</div>
                    ${q.img ? `<img src="${q.img}" onclick="openLightbox(this.src)" style="max-height:150px; border-radius:10px; cursor:zoom-in;">` : ''}
                    <div style="margin-top:10px;">${opsHtml}</div>
                    ${descHtml}
                `;
                cont.appendChild(div);
            });
        }

        function renderContent(str) {
            if(str.startsWith('http') || str.startsWith('/uploads')) return `<img src="${str}" onclick="openLightbox(this.src)" style="max-height:50px; vertical-align:middle;">`;
            return str;
        }

        // Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ú©Ù…Ú©ÛŒ
        function openLightbox(src) {
            document.getElementById('lightboxImg').src = src;
            document.getElementById('lightbox').style.display = 'flex';
        }
        function launchConfetti() {
            const c = document.getElementById('confetti-canvas');
            const ctx = c.getContext('2d');
            c.width = window.innerWidth; c.height = window.innerHeight;
            const p = Array.from({length:100}, () => ({x:Math.random()*c.width, y:Math.random()*c.height-c.height, c:`hsl(${Math.random()*360},100%,50%)`, v:Math.random()*5+2}));
            function draw(){ctx.clearRect(0,0,c.width,c.height);p.forEach(k=>{k.y+=k.v;ctx.fillStyle=k.c;ctx.beginPath();ctx.arc(k.x,k.y,5,0,Math.PI*2);ctx.fill();if(k.y>c.height)k.y=0;});requestAnimationFrame(draw);}
            draw(); setTimeout(()=>c.style.display='none',3000);
        }

        // Ø´Ø±ÙˆØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡
        window.addEventListener('load', init);
    </script>
</body>
</html>
