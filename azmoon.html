<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø³Ø§Ù„Ù† Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ù‡ÙˆØ´Ù…Ù†Ø¯</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" />
    <style>
        :root { --primary: #2c3e50; --accent: #8e44ad; --bg: #f0f2f5; --success: #27ae60; --danger: #c0392b; --warning: #f1c40f; }
        body { font-family: 'Vazirmatn', sans-serif; background: var(--bg); margin: 0; padding: 15px; min-height: 100vh; display: flex; flex-direction: column; align-items: center; user-select: none; -webkit-tap-highlight-color: transparent; }

        /* Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ */
        .card { background: white; width: 100%; max-width: 650px; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); margin-bottom: 20px; text-align: center; animation: fadeIn 0.5s; position: relative; overflow: hidden; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ */
        .btn { border: none; padding: 12px; border-radius: 12px; font-size: 1rem; cursor: pointer; font-family: inherit; width: 100%; font-weight: bold; transition: 0.2s; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:active { transform: scale(0.98); }
        .btn-next { background: #2980b9; color: white; }
        .btn-finish { background: var(--success); color: white; display: none; }
        .btn-back { background: #ecf0f1; color: #2c3e50; }
        
        /* Ù„ÛŒØ³Øª Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§ */
        .exam-item { background: #fff; border: 2px solid #e1bee7; border-radius: 16px; padding: 15px; margin-bottom: 12px; text-align: right; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; position: relative; }
        .exam-item:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .exam-item.locked { background: #f8f9fa; border-color: #bdc3c7; opacity: 0.9; }
        
        /* ØªØ§ÛŒÙ…Ø± */
        .timer-box { font-size: 1.4rem; font-weight: bold; color: var(--danger); background: #fadbd8; padding: 5px 15px; border-radius: 12px; display: inline-block; }

        /* ØªØµØ§ÙˆÛŒØ± Ùˆ Ù„Ø§ÛŒØªâ€ŒØ¨Ø§Ú©Ø³ */
        .q-image { width: 100%; max-height: 250px; object-fit: contain; border-radius: 12px; border: 1px solid #eee; margin: 10px 0; cursor: zoom-in; background: #fafafa; }
        #lightbox { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: none; justify-content: center; align-items: center; cursor: zoom-out; backdrop-filter: blur(5px); }
        #lightbox img { max-width: 95%; max-height: 95%; border-radius: 10px; box-shadow: 0 0 50px rgba(255,255,255,0.2); animation: zoomIn 0.3s; }
        @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ */
        .option { background: #f8f9fa; border: 2px solid #e9ecef; padding: 15px; border-radius: 12px; margin-bottom: 10px; cursor: pointer; text-align: right; transition: 0.2s; display: flex; flex-direction: column; align-items: flex-start; gap: 8px; }
        .option:hover { border-color: #b2bec3; }
        .option.selected { background: #e8f6f3; border-color: var(--success); color: var(--success); font-weight: bold; box-shadow: 0 4px 10px rgba(39, 174, 96, 0.2); transform: scale(1.01); }
        /* Ø§ØµÙ„Ø§Ø­ Ø³Ø§ÛŒØ² ØªØµØ§ÙˆÛŒØ± Ø¯Ø± Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ */
        .option img { max-width: 100%; height: auto; max-height: 180px; border-radius: 8px; border: 1px solid #ddd; object-fit: contain; align-self: center; margin-top: 5px; }

        /* Ù†ÙˆØ§Ø± Ù†Ù…Ø±Ù‡ Ù¾ÛŒØ´Ø±ÙØªÙ‡ */
        .score-container { margin: 40px 0 20px 0; position: relative; padding-top: 15px; direction: ltr; } /* LTR Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ù‚ÛŒÙ‚ left */
        .score-bar { height: 25px; width: 100%; border-radius: 15px; background: linear-gradient(90deg, #e74c3c 0%, #e74c3c 39%, #f1c40f 40%, #f1c40f 59%, #2ecc71 60%, #2ecc71 79%, #8e44ad 80%, #8e44ad 100%); position: relative; box-shadow: inset 0 3px 6px rgba(0,0,0,0.2); overflow: hidden; }
        
        /* Ù†Ø´Ø§Ù†Ú¯Ø± ÙÙ„Ø´ */
        .score-pointer { 
            position: absolute; 
            top: -10px; 
            width: 0; 
            height: 0; 
            border-left: 10px solid transparent; 
            border-right: 10px solid transparent; 
            border-top: 18px solid #2c3e50; 
            transform: translateX(-50%); 
            transition: left 1.5s cubic-bezier(0.22, 1, 0.36, 1); 
            left: 0%; 
            z-index: 10;
        }
        .score-pointer::after { content: ''; position: absolute; top: -20px; left: -2px; width: 4px; height: 4px; background: white; border-radius: 50%; }

        .score-text { font-size: 2rem; font-weight: bold; margin-top: 25px; color: #2c3e50; text-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        #loading { color: #7f8c8d; font-weight: bold; margin-top: 20px; }
        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9998; }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„ Ù…Ø±ÙˆØ± */
        .review-q { border-bottom: 1px solid #eee; padding: 20px 0; }
        .r-opt { padding: 10px; margin: 5px 0; border-radius: 10px; border: 1px solid #eee; background: #fff; }
        .r-opt.correct { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .r-opt.wrong { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
    </style>
</head>
<body>

    <canvas id="confetti-canvas"></canvas>

    <div id="lightbox" onclick="this.style.display='none'">
        <img id="lightboxImg" src="">
    </div>

    <div id="lobby" class="card">
        <div style="font-size: 3.5rem; margin-bottom: 5px;">ğŸ“</div>
        <h2 id="welcomeText" style="margin:0 0 10px 0;">Ø³Ø§Ù„Ù† Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</h2>
        <div id="loading">â³ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª...</div>
        <div id="examList"></div>
        <button class="btn btn-back" onclick="window.location.href='index.html'">ğŸ  Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ú©Ù„Ø§Ø³</button>
    </div>

    <div id="examArea" class="card" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #f1f2f6; padding-bottom: 10px;">
            <span id="qProgress" style="font-weight:bold; color:var(--primary);">Ø³ÙˆØ§Ù„ Û±</span>
            <div id="timer" class="timer-box">00:00</div>
        </div>
        <img id="questionImage" class="q-image" src="" onclick="openLightbox(this.src)" style="display:none;">
        <h3 id="questionText" style="text-align: right; line-height: 1.8; font-size: 1.1rem; color: #34495e;">...</h3>
        <div id="optionsContainer"></div>
        <button id="btnNext" class="btn btn-next" onclick="nextQuestion()">Ø³ÙˆØ§Ù„ Ø¨Ø¹Ø¯ÛŒ â¬…ï¸</button>
        <button id="btnFinish" class="btn btn-finish" onclick="finishExam()">âœ… Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ Ø¢Ø²Ù…ÙˆÙ†</button>
    </div>

    <div id="reportCard" class="card" style="display: none;">
        <h2 style="color:var(--accent);">ğŸ“Š Ù†ØªÛŒØ¬Ù‡ Ø¹Ù…Ù„Ú©Ø±Ø¯</h2>
        <h4 id="reportTitle" style="color:#7f8c8d; margin-top:0;"></h4>
        
        <div class="score-container">
            <div class="score-bar">
                <div id="scorePointer" class="score-pointer"></div>
            </div>
            <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#aaa; margin-top:5px; direction:ltr;">
                <span>0%</span><span>40%</span><span>60%</span><span>80%</span><span>100%</span>
            </div>
        </div>
        
        <div id="qualitativeScore" class="score-text">...</div>

        <div id="xpMsg" style="background:#e8f6f3; color:#16a085; padding:10px; border-radius:10px; margin-bottom:15px; display:none; margin-top:20px;">
            âœ… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± Ø³Ø±ÙˆØ± Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.
        </div>

        <button id="btnReview" class="btn" style="background:#f39c12; color:white; display:none;" onclick="startReviewMode()">ğŸ” ØªØ­Ù„ÛŒÙ„ Ùˆ Ù…Ø±ÙˆØ± Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§</button>
        <button class="btn btn-back" onclick="location.reload()">ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„ÛŒØ³Øª Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§</button>
    </div>

    <div id="reviewArea" class="card" style="display: none; text-align: right;">
        <h3 style="text-align:center; color:#e67e22; border-bottom:2px solid #eee; padding-bottom:10px;">ğŸ§ ØªØ­Ù„ÛŒÙ„ Ø¢Ø²Ù…ÙˆÙ†</h3>
        <div id="reviewContent"></div>
        <button class="btn btn-back" onclick="location.reload()">Ù¾Ø§ÛŒØ§Ù† Ù…Ø±ÙˆØ±</button>
    </div>

    <script src="rank.js"></script>
    <script>
        const API_URL = "https://chamran-api.liara.run"; 
        const EXAM_STATE_KEY = "chamran_exam_active_session_v4"; 
        
        let currentUser = null;
        let examsMap = {};
        let currentExamId = null;
        let currentQuestions = [];
        let currentQIndex = 0;
        let userAnswers = {};
        let timerInterval;
        let timeRemaining = 0;

        function init() {
            const savedUser = localStorage.getItem('chamran_db_vfinal_creds');
            if(!savedUser) { window.location.href = 'index.html'; return; }
            try {
                currentUser = JSON.parse(savedUser);
                document.getElementById('welcomeText').innerText = `Ø³Ù„Ø§Ù… ${currentUser.displayName}`;
                SyncManager.init(currentUser.username, currentUser.password);
                
                // Ø¨Ø±Ø±Ø³ÛŒ Ù…ÙˆØ¯: Ø¢ÛŒØ§ Ø¨Ø±Ø§ÛŒ Ù…Ø±ÙˆØ± Ø¢Ù…Ø¯Ù‡ØŸ
                const urlParams = new URLSearchParams(window.location.search);
                if(urlParams.get('mode') === 'history_review') {
                    prepareReviewMode();
                } else {
                    // Ø¯Ø± ØºÛŒØ± Ø§ÛŒÙ† ØµÙˆØ±ØªØŒ Ù„ÛŒØ³Øª Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ú¯ÛŒØ±
                    performFullSync();
                }
            } catch(e) { window.location.href = 'index.html'; }
        }

        async function performFullSync() {
            try {
                // 1. Ø¯Ø±ÛŒØ§ÙØª Ø¯ÛŒØªØ§ÛŒ ÛŒÙˆØ²Ø± (Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¯Ù† Ø§ÛŒÙ†Ú©Ù‡ Ú©Ø¯Ø§Ù… Ø±Ø§ Ø´Ø±Ú©Øª Ú©Ø±Ø¯Ù‡)
                const res = await fetch(API_URL, {
                    method: 'POST', headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ action: 'login', username: currentUser.username, password: currentUser.password })
                });
                const userData = await res.json();
                
                // 2. Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§
                const resExams = await fetch(API_URL, {
                    method: 'POST', headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ action: 'get_exams' })
                });
                const examData = await resExams.json();

                if(userData.status === 'success' && examData.status === 'success') {
                    RankSystem.init(userData.jsonData);
                    processExams(examData.data);
                    checkActiveSession(); // Ú†Ú© Ú©Ø±Ø¯Ù† Ø¢Ø²Ù…ÙˆÙ† Ù†Ø§ØªÙ…Ø§Ù…
                } else { throw new Error("Server Error"); }
            } catch(e) {
                document.getElementById('loading').innerHTML = `<span style="color:red">âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±</span>`;
            }
        }

        function processExams(list) {
            examsMap = {};
            const container = document.getElementById('examList');
            container.innerHTML = '';
            document.getElementById('loading').style.display = 'none';

            if(list.length === 0) { container.innerHTML = "<p>Ø¢Ø²Ù…ÙˆÙ†ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>"; return; }

            list.reverse().forEach(ex => {
                examsMap[ex.id] = ex;
                // Ø¨Ø±Ø±Ø³ÛŒ Ø¯ÛŒØªØ§ÛŒ Ø³Ø±ÙˆØ±
                const userExams = RankSystem.data.exams || {};
                const score = userExams[ex.id]; 
                const isTaken = (score !== undefined);

                const div = document.createElement('div');
                div.className = `exam-item ${isTaken ? 'locked' : ''}`;
                
                let btnHtml = '';
                if(isTaken) {
                    // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ØªÙ† Ú©ÛŒÙÛŒ Ø¨Ø±Ø§ÛŒ Ù„ÛŒØ³Øª
                    let quality = "Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡";
                    if(score >= 20) quality = "ÙÙˆÙ‚â€ŒØ§Ù„Ø¹Ø§Ø¯Ù‡";
                    else if(score >= 16) quality = "Ø®ÛŒÙ„ÛŒ Ø®ÙˆØ¨";
                    else if(score >= 12) quality = "Ø®ÙˆØ¨";
                    else if(score >= 8) quality = "Ù‚Ø§Ø¨Ù„ Ù‚Ø¨ÙˆÙ„";
                    else quality = "Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªÙ„Ø§Ø´";

                    const color = score >= 15 ? '#27ae60' : (score < 10 ? '#c0392b' : '#f39c12');
                    btnHtml = `
                        <div style="text-align:left;">
                            <span style="font-weight:bold; color:${color}; font-size:0.9rem;">${quality}</span>
                            <br>
                            <button onclick="goToReview('${ex.id}')" style="background:none; border:none; color:#2980b9; cursor:pointer; font-size:0.8rem; padding:0; margin-top:5px;">ğŸ” Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù¾Ø§Ø³Ø®â€ŒØ¨Ø±Ú¯</button>
                        </div>`;
                } else {
                    const lockIcon = (ex.pass) ? 'ğŸ”’ ' : '';
                    btnHtml = `<button class="btn" style="width:auto; padding:5px 15px; font-size:0.9rem; background:var(--accent); color:white;" onclick="checkStart('${ex.id}')">${lockIcon}Ø´Ø±ÙˆØ¹</button>`;
                }

                div.innerHTML = `
                    <div class="exam-info">
                        <h4>${ex.title} ${ex.is_new ? '<span style="background:red; color:white; font-size:0.6rem; padding:2px 5px; border-radius:4px;">Ø¬Ø¯ÛŒØ¯</span>' : ''}</h4>
                        <small>â±ï¸ ${ex.time} Ø¯Ù‚ÛŒÙ‚Ù‡ | ${ex.questions.length} Ø³ÙˆØ§Ù„</small>
                    </div>
                    ${btnHtml}
                `;
                container.appendChild(div);
            });
        }

        function checkStart(id) {
            const ex = examsMap[id];
            if(ex.pass) {
                const p = prompt("ğŸ”’ Ø±Ù…Ø² Ø¢Ø²Ù…ÙˆÙ† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:");
                if(p !== ex.pass) return alert("âŒ Ø±Ù…Ø² Ù†Ø§Ø¯Ø±Ø³Øª Ø§Ø³Øª");
            }
            if(confirm(`Ø¢Ø²Ù…ÙˆÙ† "${ex.title}" Ø¢ØºØ§Ø² Ø´ÙˆØ¯ØŸ\nâš ï¸ Ø²Ù…Ø§Ù†: ${ex.time} Ø¯Ù‚ÛŒÙ‚Ù‡`)) {
                startExam(id);
            }
        }

        function startExam(id) {
            const ex = examsMap[id];
            currentExamId = id;
            currentQuestions = ex.questions;
            currentQIndex = 0;
            userAnswers = {};
            
            const now = Math.floor(Date.now() / 1000);
            const durationSec = parseInt(ex.time) * 60;
            const session = { id: id, start: now, end: now + durationSec, questions: ex.questions };
            localStorage.setItem(EXAM_STATE_KEY, JSON.stringify(session));
            
            timeRemaining = durationSec;
            showExamUI();
            SyncManager.addToQueue('report', { lesson: `Ø¢Ø²Ù…ÙˆÙ†: ${ex.title}`, status: 'Ø´Ø±ÙˆØ¹', details: 'ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¬Ù„Ø³Ù‡' });
        }

        function checkActiveSession() {
            const saved = localStorage.getItem(EXAM_STATE_KEY);
            if(saved) {
                try {
                    const session = JSON.parse(saved);
                    const now = Math.floor(Date.now() / 1000);
                    const remaining = session.end - now;
                    if(remaining > 0) {
                        document.getElementById('resumeAlert').style.display = 'block';
                        setTimeout(() => {
                            currentExamId = session.id;
                            currentQuestions = session.questions;
                            currentQIndex = 0; 
                            timeRemaining = remaining;
                            userAnswers = {}; 
                            showExamUI();
                        }, 1500);
                    } else {
                        localStorage.removeItem(EXAM_STATE_KEY);
                    }
                } catch(e) { localStorage.removeItem(EXAM_STATE_KEY); }
            }
        }

        function showExamUI() {
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('examArea').style.display = 'block';
            startTimer();
            loadQuestion();
        }

        function startTimer() {
            clearInterval(timerInterval);
            const display = document.getElementById('timer');
            timerInterval = setInterval(() => {
                timeRemaining--;
                const m = Math.floor(timeRemaining / 60);
                const s = timeRemaining % 60;
                display.innerText = `${m}:${s < 10 ? '0'+s : s}`;
                if(timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    alert("â° Ø²Ù…Ø§Ù† ØªÙ…Ø§Ù… Ø´Ø¯!");
                    finishExam(true);
                }
            }, 1000);
        }

        function loadQuestion() {
            const q = currentQuestions[currentQIndex];
            document.getElementById('qProgress').innerText = `Ø³ÙˆØ§Ù„ ${currentQIndex+1} Ø§Ø² ${currentQuestions.length}`;
            document.getElementById('questionText').innerText = q.q;
            
            const imgEl = document.getElementById('questionImage');
            if(q.img && q.img.length > 3) {
                imgEl.src = q.img; imgEl.style.display = 'block';
            } else { imgEl.style.display = 'none'; }

            const cont = document.getElementById('optionsContainer');
            cont.innerHTML = '';
            
            q.options.forEach((opt, idx) => {
                const val = idx + 1;
                const div = document.createElement('div');
                div.className = `option ${userAnswers[currentQIndex] === val ? 'selected' : ''}`;
                
                let content = `<span class="opt-text">${opt}</span>`;
                // ØªØ´Ø®ÛŒØµ Ø¹Ú©Ø³
                if(opt.startsWith('http') || opt.startsWith('/uploads')) {
                    content = `<img src="${opt}" onclick="event.stopPropagation(); openLightbox('${opt}')">`;
                }
                
                div.innerHTML = `<span style="font-weight:bold; color:#7f8c8d; margin-left:10px;">${val})</span> ${content}`;
                div.onclick = () => selectOption(val, div);
                cont.appendChild(div);
            });

            const isLast = currentQIndex === currentQuestions.length - 1;
            document.getElementById('btnNext').style.display = isLast ? 'none' : 'block';
            document.getElementById('btnFinish').style.display = isLast ? 'block' : 'none';
        }

        function selectOption(val, el) {
            document.querySelectorAll('.option').forEach(o => o.classList.remove('selected'));
            el.classList.add('selected');
            userAnswers[currentQIndex] = val;
        }

        function nextQuestion() { currentQIndex++; loadQuestion(); }

        function finishExam(forced = false) {
            clearInterval(timerInterval);
            localStorage.removeItem(EXAM_STATE_KEY); 

            let correctCount = 0;
            let wrongIndices = [];
            currentQuestions.forEach((q, idx) => {
                if(userAnswers[idx] == q.correct) correctCount++;
                else wrongIndices.push(idx + 1);
            });

            const score20 = (correctCount / currentQuestions.length) * 20;
            const finalScore = parseFloat(score20.toFixed(1)); 

            // Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±
            SyncManager.addToQueue('claim_reward', {
                reward_type: 'exam',
                reward_id: currentExamId,
                exam_score: finalScore,
                wrong_list: wrongIndices,
                user_answers: userAnswers
            });
            
            showReportCard(finalScore);
        }

        function showReportCard(score) {
            document.getElementById('examArea').style.display = 'none';
            document.getElementById('reportCard').style.display = 'block';

            // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ø±ØµØ¯ Ø¨Ø±Ø§ÛŒ Ù†ÙˆØ§Ø±
            const percent = (score / 20) * 100;
            
            // Ø§Ù†ÛŒÙ…ÛŒØ´Ù† ÙÙ„Ø´ Ù‡ÙˆØ´Ù…Ù†Ø¯ (Pointer)
            setTimeout(() => {
                // ÙÙ„Ø´ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ø±ÙˆÛŒ Ø¯Ø±ØµØ¯ Ù…ÛŒâ€ŒØ±ÙˆØ¯
                document.getElementById('scorePointer').style.left = percent + '%';
            }, 300);

            // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ØªÙ† Ú©ÛŒÙÛŒ Ø¯Ù‚ÛŒÙ‚
            let quality = "";
            let color = "";
            
            if(percent >= 100) { quality = "ğŸ’ ÙÙˆÙ‚â€ŒØ§Ù„Ø¹Ø§Ø¯Ù‡"; color = "#8e44ad"; launchConfetti(); }
            else if(percent >= 80) { quality = "ğŸ¥‡ Ø®ÛŒÙ„ÛŒ Ø®ÙˆØ¨"; color = "#2ecc71"; }
            else if(percent >= 60) { quality = "ğŸ™‚ Ø®ÙˆØ¨"; color = "#2980b9"; }
            else if(percent >= 40) { quality = "âš ï¸ Ù‚Ø§Ø¨Ù„ Ù‚Ø¨ÙˆÙ„"; color = "#f1c40f"; }
            else { quality = "â›” Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªÙ„Ø§Ø´ Ø¨ÛŒØ´ØªØ±"; color = "#c0392b"; }

            const qEl = document.getElementById('qualitativeScore');
            qEl.innerText = quality;
            qEl.style.color = color;

            document.getElementById('btnReview').style.display='block'; 
            document.getElementById('xpMsg').style.display='block';
        }

        // --- Ø¨Ø®Ø´ Ù…Ø±ÙˆØ± Ùˆ ØªØ§Ø±ÛŒØ®Ú†Ù‡ ---
        function goToReview(examId) {
            window.location.href = `azmoon.html?mode=history_review&target=${examId}`;
        }

        async function prepareReviewMode() {
            const urlParams = new URLSearchParams(window.location.search);
            const targetId = urlParams.get('target');
            
            document.getElementById('loading').innerHTML = "Ø¯Ø±Ø­Ø§Ù„ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ù¾Ø§Ø³Ø®â€ŒØ¨Ø±Ú¯...";
            document.getElementById('loading').style.display = 'block';

            // 1. Ø§ÙˆÙ„ Ø¯ÛŒØªØ§ÛŒ ÛŒÙˆØ²Ø± (Ù¾Ø§Ø³Ø®â€ŒØ¨Ø±Ú¯) Ø±Ø§ Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ…
            const resUser = await fetch(API_URL, {
                method: 'POST', headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ action: 'login', username: currentUser.username, password: currentUser.password })
            });
            const userData = await resUser.json();
            RankSystem.init(userData.jsonData); 

            // 2. Ø­Ø§Ù„Ø§ Ø³ÙˆØ§Ù„Ø§Øª Ø¢Ø²Ù…ÙˆÙ† Ø±Ø§ Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ…
            const resExams = await fetch(API_URL, {
                method: 'POST', headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ action: 'get_exams' })
            });
            const examData = await resExams.json();

            // 3. ØªØ±Ú©ÛŒØ¨ Ø§Ø·Ù„Ø§Ø¹Ø§Øª
            if(userData.status === 'success' && examData.status === 'success') {
                const userDetails = RankSystem.data.exam_details || {};
                const myData = userDetails[targetId];
                
                // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø¢Ø²Ù…ÙˆÙ† Ø§Ø² Ù„ÛŒØ³Øª
                const examObj = examData.data.find(e => String(e.id) === String(targetId));

                if(!examObj || !myData) { 
                    alert("Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ÛŒÙ† Ø¢Ø²Ù…ÙˆÙ† ÛŒØ§ÙØª Ù†Ø´Ø¯ (Ø´Ø§ÛŒØ¯ Ø­Ø°Ù Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯)."); 
                    window.location.href='azmoon.html'; 
                    return; 
                }
                
                currentQuestions = examObj.questions;
                userAnswers = myData.answers || {};
                
                document.getElementById('lobby').style.display = 'none';
                document.getElementById('reviewArea').style.display = 'block';
                renderReview();
            } else {
                alert("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª");
            }
        }

        function renderReview() {
            const cont = document.getElementById('reviewContent');
            cont.innerHTML = '';
            
            currentQuestions.forEach((q, idx) => {
                const uAns = userAnswers[idx];
                const cAns = q.correct;
                const isCorrect = (uAns == cAns);
                
                let statusIcon = isCorrect ? 'âœ…' : 'âŒ';
                if(!uAns) statusIcon = 'âšª'; 

                const div = document.createElement('div');
                div.className = 'review-q';
                
                let opsHtml = '';
                q.options.forEach((op, i) => {
                    const val = i+1;
                    let style = "padding:10px; margin:5px 0; border-radius:10px; border:1px solid #eee;";
                    
                    // Ù…Ù†Ø·Ù‚ Ø±Ù†Ú¯â€ŒØ¨Ù†Ø¯ÛŒ Ù…Ø±ÙˆØ±
                    if(val == cAns) style += "background:#d4edda; color:#155724; border-color:#c3e6cb;"; // Ø³Ø¨Ø² (ØµØ­ÛŒØ­)
                    else if(val == uAns && !isCorrect) style += "background:#f8d7da; color:#721c24; border-color:#f5c6cb;"; // Ù‚Ø±Ù…Ø² (Ø§Ù†ØªØ®Ø§Ø¨ ØºÙ„Ø·)
                    else style += "background:#fff; color:#777;";

                    opsHtml += `<div style="${style}">${val}) ${renderContent(op)}</div>`;
                });

                let descHtml = '';
                if(q.desc || q.desc_img) {
                    descHtml = `
                        <div style="background:#fff3cd; padding:10px; border-radius:8px; margin-top:10px; font-size:0.9rem;">
                            <strong>ğŸ’¡ ØªÙˆØ¶ÛŒØ­ Ø§Ø³ØªØ§Ø¯:</strong> ${q.desc || ''}
                            ${q.desc_img ? `<br><img src="${q.desc_img}" onclick="openLightbox(this.src)" style="max-height:150px; margin-top:5px; cursor:zoom-in;">` : ''}
                        </div>`;
                }

                div.innerHTML = `
                    <div style="font-weight:bold; margin-bottom:10px;">${statusIcon} Ø³ÙˆØ§Ù„ ${idx+1}</div>
                    <div style="margin-bottom:10px; line-height:1.6;">${q.q}</div>
                    ${q.img ? `<img src="${q.img}" onclick="openLightbox(this.src)" style="max-height:200px; border-radius:10px; cursor:zoom-in; margin-bottom:10px;">` : ''}
                    <div>${opsHtml}</div>
                    ${descHtml}
                `;
                cont.appendChild(div);
            });
        }

        function renderContent(str) {
            if(str.startsWith('http') || str.startsWith('/uploads')) return `<img src="${str}" onclick="openLightbox(this.src)" style="max-height:120px; vertical-align:middle; border-radius:5px;">`;
            return str;
        }

        function openLightbox(src) {
            document.getElementById('lightboxImg').src = src;
            document.getElementById('lightbox').style.display = 'flex';
        }
        function launchConfetti() {
            const c = document.getElementById('confetti-canvas');
            const ctx = c.getContext('2d');
            c.width = window.innerWidth; c.height = window.innerHeight;
            const p = Array.from({length:100}, () => ({x:Math.random()*c.width, y:Math.random()*c.height-c.height, c:`hsl(${Math.random()*360},100%,50%)`, v:Math.random()*5+2}));
            function draw(){ctx.clearRect(0,0,c.width,c.height);p.forEach(k=>{k.y+=k.v;ctx.fillStyle=k.c;ctx.beginPath();ctx.arc(k.x,k.y,5,0,Math.PI*2);ctx.fill();if(k.y>c.height)k.y=0;});requestAnimationFrame(draw);}
            draw(); setTimeout(()=>c.style.display='none',3000);
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>
