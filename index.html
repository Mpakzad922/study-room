<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…ÛŒØ² Ù…Ø·Ø§Ù„Ø¹Ù‡ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ú†Ù…Ø±Ø§Ù†</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">

    <style>
        :root { --primary: #2c3e50; --accent: #e67e22; --bg: #ecf0f1; --success: #27ae60; --danger: #c0392b; --gold: linear-gradient(45deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c); }
        body { font-family: 'Vazirmatn', sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 10px; box-sizing: border-box; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ - Ø¯Ø± Ø§Ø¨ØªØ¯Ø§ Ù…Ø®ÙÛŒ Ù‡Ø³ØªÙ†Ø¯ ØªØ§ Ø§Ù†ÛŒÙ…ÛŒØ´Ù† ÙˆØ±ÙˆØ¯ Ø§Ø¬Ø±Ø§ Ø´ÙˆØ¯ */
        .card { background: white; width: 100%; max-width: 500px; padding: 25px 20px; border-radius: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); margin-top: 15px; text-align: center; display: none; opacity: 0; transition: opacity 1s ease-in-out; }
        .card.show-content { opacity: 1; } /* Ú©Ù„Ø§Ø³ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†Ø±Ù… Ù…Ø­ØªÙˆØ§ */
        .active { display: block; } /* Ø§Ú©ØªÛŒÙˆ ÙÙ‚Ø· Ø¯ÛŒØ³Ù¾Ù„ÛŒ Ø±Ø§ Ø¨Ø§Ø² Ù…ÛŒÚ©Ù†Ø¯ØŒ Ø§ÙˆÙ¾Ø§Ø³ÛŒØªÛŒ Ø¨Ø§ show-content Ø§Ø³Øª */

        .video-item { background: #fff; border: 2px solid #f1f2f6; border-radius: 15px; margin-bottom: 15px; padding: 15px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: all 0.2s; text-align: right; }
        .video-item:active { transform: scale(0.98); border-color: var(--accent); }
        .video-item.done { border-color: var(--success); background: #f0fdf4; }
        .video-icon { font-size: 1.5rem; background: #f1f2f6; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; border-radius: 12px; color: var(--primary); }
        .logout-btn { font-size: 0.75rem; color: var(--danger); background: #ffebee; padding: 4px 10px; border-radius: 8px; cursor: pointer; border: 1px solid var(--danger); display: inline-block; margin-top: 5px; }
        input { width: 100%; padding: 15px; margin: 20px 0; border: 2px solid #dfe6e9; border-radius: 15px; text-align: center; font-family: inherit; font-size: 1rem; outline: none; box-sizing: border-box; }
        input:focus { border-color: var(--accent); }
        .btn-main { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 15px; cursor: pointer; width: 100%; font-family: inherit; font-size: 1.1rem; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        video { width: 100%; border-radius: 15px; background: #000; margin-top: 15px; max-height: 80vh; outline: none; }
        .alert-box { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #c0392b; color: white; padding: 10px 20px; border-radius: 30px; z-index: 9999; display: none; font-size: 0.9rem; width: max-content; }
        .progress-bar { width: 100%; background: #dfe6e9; height: 8px; border-radius: 4px; margin-top: 15px; overflow: hidden; direction: ltr; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }
        .back-btn { background: #f1f2f6; border: none; padding: 8px 15px; border-radius: 10px; color: #636e72; cursor: pointer; font-family: inherit; }
        #downloadContainer { margin-top: 20px; display: grid; gap: 10px; }
        .download-btn { background: #fff; color: #34495e; text-decoration: none; padding: 12px 15px; border-radius: 12px; font-size: 0.9rem; display: flex; align-items: center; justify-content: space-between; border: 2px solid #ecf0f1; transition: 0.3s; }
        .download-btn:hover { border-color: var(--primary); background: #f8f9fa; transform: translateY(-2px); }
        .dl-icon { font-size: 1.2rem; margin-left: 10px; }
        .dl-text { font-weight: bold; }
        .dl-arrow { color: var(--accent); font-size: 0.8rem; }
        #securityModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .security-box { background: white; padding: 30px; border-radius: 20px; width: 85%; max-width: 400px; text-align: center; border: 4px solid var(--primary); }
        .math-question { font-size: 2rem; font-weight: bold; color: var(--primary); margin: 20px 0; direction: ltr; font-family: 'Vazirmatn', sans-serif; }
        .wrong-ans { border-color: red !important; background: #ffebee; }
        .timer-circle { width: 70px; height: 70px; background: var(--danger); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; font-weight: bold; margin: 0 auto 10px auto; border: 4px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.2); padding-top: 5px; }
        #loading { margin-top: 20px; display:none; color: #7f8c8d; }
        .offline-badge { position:fixed; bottom:10px; left:10px; background:orange; color:white; padding:8px 15px; border-radius:30px; font-size:0.8rem; display:none; z-index:2000; box-shadow: 0 4px 10px rgba(0,0,0,0.2); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .fullscreen-btn { background: #34495e; color: white; border: none; padding: 8px 15px; border-radius: 8px; margin-top: 5px; font-size: 0.8rem; cursor: pointer; display: inline-flex; align-items: center; gap: 5px; }

        /* =========================================
           Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø§Ù…Ø¶Ø§ÛŒ Ø·Ù„Ø§ÛŒÛŒ Ùˆ Ø§Ù†ÛŒÙ…ÛŒØ´Ù† ÙˆØ±ÙˆØ¯
        ========================================= */
        /* Ù„Ø§ÛŒÙ‡ Ø±ÙˆÛŒÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø´Ø±ÙˆØ¹ */
        #intro-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 5000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: all 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55); /* Ø­Ø±Ú©Øª Ù†Ø±Ù… Ùˆ ÙÙ†Ø±ÛŒ */
        }
        /* ÙˆÙ‚ØªÛŒ Ú©Ù„Ø§Ø³ move-down Ø§Ø¶Ø§ÙÙ‡ Ø´ÙˆØ¯ØŒ Ø¨Ù‡ Ù¾Ø§ÛŒÛŒÙ† Ø­Ø±Ú©Øª Ù…ÛŒâ€ŒÚ©Ù†Ø¯ */
        #intro-overlay.move-down {
            top: 85%; /* Ø­Ø±Ú©Øª Ø¨Ù‡ Ø³Ù…Øª Ù¾Ø§ÛŒÛŒÙ† */
            transform: scale(0.6); /* Ú©ÙˆÚ†Ú© Ø´Ø¯Ù† */
            opacity: 0; /* Ù…Ø­Ùˆ Ø´Ø¯Ù† ØªØ¯Ø±ÛŒØ¬ÛŒ */
            pointer-events: none; /* Ø¯ÛŒÚ¯Ø± Ù‚Ø§Ø¨Ù„ Ú©Ù„ÛŒÚ© Ù†Ø¨Ø§Ø´Ø¯ */
        }

        /* Ø§Ø³ØªØ§ÛŒÙ„ Ù…ØªÙ† Ø§Ù…Ø¶Ø§ */
        .signature-container { text-align: center; direction: ltr; }
        .sig-prefix {
            font-family: 'Montserrat', sans-serif; font-size: 0.9rem; color: #7f8c8d; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 5px;
        }
        .sig-name {
            font-family: 'Cinzel Decorative', cursive; font-size: 2.5rem; font-weight: 700;
            background: var(--gold); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            position: relative; display: inline-block; padding: 5px;
        }
        /* Ø§ÙÚ©Øª Ø¨Ø±Ø§Ù‚ Ø´Ø¯Ù† (Shine Effect) */
        .sig-name::after {
            content: attr(data-text); position: absolute; left: 0; top: 0; padding: 5px; z-index: -1;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.8), transparent);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-size: 200%; background-position: -100%;
            animation: shine 4s infinite linear; /* Ø³Ø±Ø¹Øª Ø­Ø±Ú©Øª Ø¨Ø±Ù‚ */
        }
        @keyframes shine { to { background-position: 200%; } }

        /* Ø§Ø³ØªØ§ÛŒÙ„ Ø§Ù…Ø¶Ø§ÛŒ Ø«Ø§Ø¨Øª Ø¯Ø± ÙÙˆØªØ± (Ú©Ù‡ Ø¨Ø¹Ø¯ Ø§Ø² Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø¯ÛŒØ¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯) */
        .footer-signature {
            margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(0,0,0,0.05); opacity: 0; transition: opacity 2s ease;
        }
        .footer-signature.show { opacity: 1; }
        .footer-signature .sig-name { font-size: 1.5rem; } /* Ø³Ø§ÛŒØ² Ú©ÙˆÚ†Ú©ØªØ± Ø¨Ø±Ø§ÛŒ ÙÙˆØªØ± */
        .footer-signature .sig-prefix { font-size: 0.7rem; }
    </style>
</head>
<body>

    <div id="intro-overlay">
        <div class="signature-container">
            <div class="sig-prefix">Created By</div>
            <div class="sig-name" data-text="Mohammad Pakzad">Mohammad Pakzad</div>
        </div>
    </div>

    <div id="cheatAlert" class="alert-box">â›” Ø¬Ù„Ùˆ Ø²Ø¯Ù† ÙÛŒÙ„Ù… Ù…Ø¬Ø§Ø² Ù†ÛŒØ³Øª!</div>
    <div id="offlineBadge" class="offline-badge" onclick="processOfflineQueue()">ğŸ“¡ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ Ø¯Ø± ØµÙ Ø§Ø±Ø³Ø§Ù„... (Ú©Ù„ÛŒÚ© Ø¨Ø±Ø§ÛŒ ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯)</div>

    <div id="securityModal">
        <div class="security-box">
            <div id="timerDisplay" class="timer-circle">Û¶Û°</div>
            <h3>ğŸ”’ Ø­Ø¶ÙˆØ± ØºÛŒØ§Ø¨ Ù‡ÙˆØ´Ù…Ù†Ø¯</h3>
            <p style="font-size: 0.9rem; color: #555;">Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ø§Ù…Ù‡ØŒ Ø­Ø§ØµÙ„ Ø¬Ù…Ø¹ Ø²ÛŒØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:</p>
            <div id="mathQ" class="math-question">...</div>
            <input type="tel" id="mathAns" placeholder="Ù¾Ø§Ø³Ø®ØŸ">
            <button class="btn-main" onclick="checkSecurityAnswer()">Ø«Ø¨Øª Ù¾Ø§Ø³Ø® âœ…</button>
        </div>
    </div>

    <div id="screen-login" class="card">
        <div style="font-size: 4rem; margin-bottom: 10px;">ğŸ“</div>
        <h2>Ú©Ù„Ø§Ø³ Ù…Ø¬Ø§Ø²ÛŒ Ú†Ù…Ø±Ø§Ù†</h2>
        <p style="color: #7f8c8d;">Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯:</p>
        <input type="text" id="inpName" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ù…Ø¯ Ø§Ø­Ù…Ø¯ÛŒ">
        <button class="btn-main" onclick="login()">ÙˆØ±ÙˆØ¯</button>
        <div id="loading"><p>â³ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø¯Ø±Ø³â€ŒÙ‡Ø§...</p></div>
        
        <div class="signature-container footer-signature" id="loginFooterSig">
            <div class="sig-prefix">Created By</div>
            <div class="sig-name" data-text="Mohammad Pakzad">Mohammad Pakzad</div>
        </div>
    </div>

    <div id="screen-library" class="card">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px; border-bottom: 2px solid #f1f2f6; padding-bottom: 15px;">
            <div style="text-align: right;">
                <h3 style="margin:0;">Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ Ù…Ù†</h3>
                <span id="displayName" style="font-size: 0.8rem; color: var(--accent); font-weight: bold;"></span>
            </div>
            <div class="logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬ ğŸšª</div>
        </div>
        <div style="margin-bottom: 20px;">
            <button onclick="window.location.href='azmoon.html'" style="background: #8e44ad; color: white; border: none; padding: 15px; border-radius: 15px; width: 100%; font-family: inherit; font-size: 1.1rem; cursor: pointer; box-shadow: 0 4px 10px rgba(142, 68, 173, 0.3);">
                ğŸ“ ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¢Ø²Ù…ÙˆÙ† Ø¢Ù†Ù„Ø§ÛŒÙ†
            </button>
        </div>
        <div id="video-list-container"></div>
         <div class="signature-container footer-signature show" style="margin-top: 10px; border:none;">
            <div class="sig-name" data-text="M. Pakzad" style="font-size: 1rem;">M. Pakzad</div>
        </div>
    </div>

    <div id="screen-player" class="card">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <button class="back-btn" onclick="history.back()">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
            <strong id="videoTitle" style="font-size: 0.9rem;"></strong>
        </div>
        
        <video id="myVideo" playsinline controls controlsList="nodownload noplaybackrate"></video>
        
        <button class="fullscreen-btn" onclick="forceFullScreen()">
            <span>â›¶</span> ØªÙ…Ø§Ù… ØµÙØ­Ù‡
        </button>
        
        <div id="downloadContainer"></div>

        <div class="progress-bar"><div id="progressBar" class="progress-fill"></div></div>
        <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.8rem;">
            <span id="viewPercent" style="color: var(--accent); font-weight: bold;">Û°Ùª</span>
            <span id="viewStatus" style="color: #95a5a6;">Ø¯Ø± Ø­Ø§Ù„ ØªÙ…Ø§Ø´Ø§...</span>
        </div>
    </div>

    <script src="data.js" onerror="console.log('data.js not found or waiting for google')"></script>

    <script>
        // ***********************************************
        // ØªÙ†Ø¸ÛŒÙ…Ø§Øª - Ú©Ø¯Ù‡Ø§ Ú©Ø§Ù…Ù„Ø§Ù‹ Ø­ÙØ¸ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯
        // ***********************************************
        const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT5s2fIjXBtYnihTmXQNnvwfv3kUdGuwMdRkG6mTR1t4eCUxoOsYdJnRaucOlQlLlL1xJACckhfKBHh/pub?output=csv";
        const REPORT_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyTA9hNsiL9KPtq5u9Pav209AFvC6BVCiYfz3LEAqIbpNBaYju_zm_V_O8bjJjDP8FgDw/exec"; 
        // ***********************************************
        
        const CHECK_INTERVAL = 300; 
        const ANSWER_TIMEOUT = 60;
        const IDLE_TIMEOUT = 120;
        const DB_KEY = "chamran_db_v19_"; 
        
        let playlist = []; 
        let user = "";
        let activeVid = null;
        let maxTime = 0;
        let isDone = false;
        let lastReportedPercent = 0;
        let nextCheckTime = CHECK_INTERVAL;
        let correctAnswer = 0;
        let timerInterval = null;
        let lastActivityTime = Date.now();
        let idleReportSent = false;
        let backgroundTimer = null;

        const vid = document.getElementById('myVideo');

        // ***** Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ù†ÛŒÙ…ÛŒØ´Ù† ÙˆØ±ÙˆØ¯ÛŒ (Intro Animation) *****
        window.addEventListener('load', () => {
            // Ø¨Ø¹Ø¯ Ø§Ø² 2.5 Ø«Ø§Ù†ÛŒÙ‡ØŒ Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø­Ø±Ú©Øª Ø¨Ù‡ Ù¾Ø§ÛŒÛŒÙ† Ø´Ø±ÙˆØ¹ Ø´ÙˆØ¯
            setTimeout(() => {
                // 1. Ù„Ø§ÛŒÙ‡ Ø±ÙˆÛŒÛŒ Ø¨Ù‡ Ù¾Ø§ÛŒÛŒÙ† Ø­Ø±Ú©Øª Ú©Ù†Ø¯ Ùˆ Ù…Ø­Ùˆ Ø´ÙˆØ¯
                document.getElementById('intro-overlay').classList.add('move-down');
                
                // 2. Ù…Ø­ØªÙˆØ§ÛŒ Ø§ØµÙ„ÛŒ ØµÙØ­Ù‡ Ø¨Ù‡ Ù†Ø±Ù…ÛŒ Ø¸Ø§Ù‡Ø± Ø´ÙˆØ¯
                document.querySelectorAll('.card').forEach(c => c.classList.add('show-content'));
                
                // 3. Ø§Ù…Ø¶Ø§ÛŒ Ø«Ø§Ø¨Øª ÙÙˆØªØ± Ø¸Ø§Ù‡Ø± Ø´ÙˆØ¯ (Ú©Ù‡ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù‚Ø¨Ù„ÛŒ Ø´ÙˆØ¯)
                document.getElementById('loginFooterSig').classList.add('show');

                // 4. Ø¨Ø¹Ø¯ Ø§Ø² Ø§ØªÙ…Ø§Ù… Ø§Ù†ÛŒÙ…ÛŒØ´Ù†ØŒ Ù„Ø§ÛŒÙ‡ Ø±ÙˆÛŒÛŒ Ú©Ø§Ù…Ù„ Ø­Ø°Ù Ø´ÙˆØ¯ (Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªØ¯Ø§Ø®Ù„)
                setTimeout(() => {
                    document.getElementById('intro-overlay').style.display = 'none';
                }, 1200); // Ú©Ù…ÛŒ Ø¨ÛŒØ´ØªØ± Ø§Ø² Ø²Ù…Ø§Ù† ØªØ±Ø§Ù†Ø²ÛŒØ´Ù† CSS

            }, 2500); // Ù…Ø¯Øª Ø²Ù…Ø§Ù† Ù†Ù…Ø§ÛŒØ´ Ø§ÙˆÙ„ÛŒÙ‡ Ø§Ù…Ø¶Ø§ Ø¯Ø± Ù…Ø±Ú©Ø²
        });


        function toPersianNum(n) { return n.toString().replace(/\d/g, x => ['Û°','Û±','Û²','Û³','Û´','Ûµ','Û¶','Û·','Û¸','Û¹'][x]); }
        function toEnglishNum(s) { return s.replace(/[Û°-Û¹]/g, d => "Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹".indexOf(d)); }
        
        function getDeviceInfo() {
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            return (isMobile ? "ğŸ“± Mobile" : "ğŸ’» PC") + " | " + navigator.userAgent;
        }

        function forceFullScreen() {
            if (vid.requestFullscreen) { vid.requestFullscreen(); } 
            else if (vid.webkitRequestFullscreen) { vid.webkitRequestFullscreen(); } 
            else if (vid.msRequestFullscreen) { vid.msRequestFullscreen(); } 
            else if (vid.webkitEnterFullscreen) { vid.webkitEnterFullscreen(); } 
            else { alert("Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ (ÛŒØ§ ØªÙ„Ú¯Ø±Ø§Ù…) Ø§Ø¬Ø§Ø²Ù‡ ØªÙ…Ø§Ù… ØµÙØ­Ù‡ Ù†Ù…ÛŒâ€ŒØ¯Ù‡Ø¯."); }
        }

        window.addEventListener('popstate', function(event) {
            if (document.getElementById('screen-player').classList.contains('active')) {
                performExitLogic();
            }
        });

        function performExitLogic() {
            checkAndReport("Ø®Ø±ÙˆØ¬ Ø§Ø² Ø¯Ø±Ø³ ğŸ”™", true); 
            vid.pause();
            if(backgroundTimer) clearTimeout(backgroundTimer);
            renderList();
            showScreen('screen-library');
        }

        async function fetchPlaylist() {
            document.getElementById('loading').style.display = 'block';
            if (typeof LOCAL_PLAYLIST !== 'undefined' && LOCAL_PLAYLIST.length > 0) {
                playlist = LOCAL_PLAYLIST;
                initApp();
                return;
            }
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000);
            try {
                const res = await fetch(SHEET_CSV_URL + '&t=' + Date.now(), { signal: controller.signal });
                clearTimeout(timeoutId);
                if(res.ok) {
                    const data = await res.text();
                    parseCSV(data);
                    initApp();
                    return;
                }
            } catch (err) { console.log("Google failed"); }

            if(playlist.length === 0) {
                document.getElementById('loading').innerHTML = "<p style='color:red'>âš ï¸ Ù„ÛŒØ³Øª Ø¯Ø±Ø³â€ŒÙ‡Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø´Ø¯.</p>";
            }
        }

        function parseCSV(csvText) {
            playlist = [];
            const rows = csvText.split('\n');
            for(let i=1; i<rows.length; i++) {
                const row = rows[i].split(',');
                if(row.length >= 3) {
                    const id = row[0].trim();
                    const title = row[1].trim(); 
                    const file = row[2].trim();
                    let attachment = "";
                    if(row.length > 3) {
                        const remaining = rows[i].substring(rows[i].indexOf(file) + file.length);
                        attachment = remaining.trim().replace(/^,|,$/g, ''); 
                    }
                    if(id && title && file) playlist.push({ id, title, file, attachment });
                }
            }
        }

        function initApp() {
            document.getElementById('loading').style.display = 'none';
            const savedName = localStorage.getItem(DB_KEY + 'name');
            if(savedName) {
                user = savedName;
                document.getElementById('displayName').innerText = user;
                renderList();
                showScreen('screen-library');
                processOfflineQueue(); 
            } else {
                showScreen('screen-login');
            }
        }

        fetchPlaylist();

        function login() {
            const name = document.getElementById('inpName').value.trim();
            if(name.length < 3) return alert("Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ú©Ø§Ù…Ù„ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯");
            user = name;
            localStorage.setItem(DB_KEY + 'name', user);
            document.getElementById('displayName').innerText = user;
            renderList();
            showScreen('screen-library');
            processOfflineQueue();
        }

        function logout() {
            if(confirm("Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ø³Ø§Ø¨ØŸ")) {
                localStorage.removeItem(DB_KEY + 'name');
                location.reload();
            }
        }

        function renderList() {
            const list = document.getElementById('video-list-container');
            list.innerHTML = "";
            playlist.forEach(item => {
                const progress = localStorage.getItem(`${DB_KEY}${user}_${item.id}`) || 0;
                const isCompleted = progress >= 98;
                const icon = isCompleted ? 'âœ…' : 'â–¶ï¸';
                const hasFile = (item.attachment && item.attachment.length > 3);
                const attachIcon = hasFile ? '<span style="font-size:0.7rem; background:#eee; padding:2px 5px; border-radius:4px; margin-right:5px;">ğŸ“ ÙØ§ÛŒÙ„</span>' : '';

                const el = document.createElement('div');
                el.className = `video-item ${isCompleted ? 'done' : ''}`;
                el.onclick = () => playVideo(item);
                el.innerHTML = `
                    <div class="video-icon">${icon}</div>
                    <div class="video-info">
                        <h4>${item.title}</h4>
                        <div style="display:flex; align-items:center;">
                             <span class="status-text">${isCompleted ? 'ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯' : toPersianNum(progress) + 'Ùª Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø´Ø¯Ù‡'}</span>
                             ${attachIcon}
                        </div>
                    </div>
                `;
                list.appendChild(el);
            });
        }

        function playVideo(item) {
            history.pushState({ page: 'player' }, "Player", "#player");
            activeVid = item;
            document.getElementById('videoTitle').innerText = item.title;
            isDone = false;
            lastReportedPercent = 0;
            vid.src = item.file;
            lastActivityTime = Date.now();
            idleReportSent = false;
            if(backgroundTimer) clearTimeout(backgroundTimer);
            
            const dlContainer = document.getElementById('downloadContainer');
            dlContainer.innerHTML = ""; 
            if(item.attachment && item.attachment.length > 3) {
                const files = item.attachment.split(',');
                files.forEach((fileEntry, index) => {
                    fileEntry = fileEntry.trim();
                    if(!fileEntry) return;
                    let fileName = `ÙØ§ÛŒÙ„ Ø¶Ù…ÛŒÙ…Ù‡ ${toPersianNum(index + 1)}`;
                    let fileLink = fileEntry;
                    if(fileEntry.includes('|')) {
                        const parts = fileEntry.split('|');
                        fileName = parts[0].trim();
                        fileLink = parts[1].trim();
                    }
                    const btn = document.createElement('a');
                    btn.className = 'download-btn';
                    btn.href = fileLink;
                    btn.target = "_blank";
                    btn.innerHTML = `<div style="display:flex; align-items:center;"><span class="dl-icon">ğŸ“¥</span><span class="dl-text">${fileName}</span></div><span class="dl-arrow">Ø¯Ø±ÛŒØ§ÙØª âœ</span>`;
                    dlContainer.appendChild(btn);
                });
            }

            const savedTime = localStorage.getItem(`${DB_KEY}${user}_time_${item.id}`);
            maxTime = savedTime ? parseFloat(savedTime) : 0;
            nextCheckTime = maxTime + CHECK_INTERVAL; 
            showScreen('screen-player');
            if(maxTime > 5) {
                if(confirm("Ø§Ø¯Ø§Ù…Ù‡ Ù¾Ø®Ø´ Ø§Ø² Ø¬Ø§ÛŒ Ù‚Ø¨Ù„ÛŒØŸ")) vid.currentTime = maxTime;
            }
        }

        function showScreen(id) {
            document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
            const target = document.getElementById(id);
            target.classList.add('active');
            // Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø§Ø¬Ø±Ø§ÛŒ Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø§ÙˆÙ¾Ø§Ø³ÛŒØªÛŒ
            setTimeout(() => target.classList.add('show-content'), 50);
        }

        document.addEventListener("visibilitychange", () => {
            if(!activeVid || isDone) return;
            if (document.visibilityState === 'hidden') {
                checkAndReport("â›” ØªÙˆÙ‚Ù/Ø®Ø±ÙˆØ¬ (Ø¨Ø³ØªÙ† Ø¨Ø±Ù†Ø§Ù…Ù‡)", true);
                vid.pause();
            } else {
                if(backgroundTimer) clearTimeout(backgroundTimer);
                processOfflineQueue();
            }
        });

        window.addEventListener('online', processOfflineQueue); 

        setInterval(() => {
            if (!activeVid || isDone || vid.paused) return; 
            const timeDiff = (Date.now() - lastActivityTime) / 1000;
            if (timeDiff > IDLE_TIMEOUT && !idleReportSent) {
                let pText = document.getElementById('viewPercent').innerText;
                const percent = parseInt(toEnglishNum(pText).replace('Ùª', ''));
                if(percent > 5) {
                    checkAndReport("âš ï¸ ØªÙˆÙ‚Ù Ø·ÙˆÙ„Ø§Ù†ÛŒ (Ø¹Ø¯Ù… Ù¾ÛŒØ´Ø±ÙØª)", true);
                    idleReportSent = true; 
                }
            }
        }, 5000);

        vid.addEventListener('timeupdate', () => {
            if(!vid.seeking && vid.currentTime > maxTime) {
                maxTime = vid.currentTime;
                localStorage.setItem(`${DB_KEY}${user}_time_${activeVid.id}`, maxTime);
                lastActivityTime = Date.now();
                idleReportSent = false; 
            }
            if(vid.currentTime > nextCheckTime) triggerSecurityCheck();
            if(vid.duration) {
                const percent = Math.min(100, Math.floor((maxTime / vid.duration) * 100));
                document.getElementById('progressBar').style.width = percent + "%";
                document.getElementById('viewPercent').innerText = toPersianNum(percent) + "Ùª";
                localStorage.setItem(`${DB_KEY}${user}_${activeVid.id}`, percent);
                if(percent >= 98 && !isDone) {
                    isDone = true;
                    document.getElementById('viewStatus').innerText = "ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯! âœ…";
                    checkAndReport("ØªÚ©Ù…ÛŒÙ„ Ú©Ø§Ù…Ù„ Ø¯Ø±Ø³ âœ…", true);
                }
            }
        });
        
        vid.addEventListener('seeking', () => {
            if(vid.currentTime > maxTime + 3) {
                vid.currentTime = maxTime;
                document.getElementById('cheatAlert').style.display = 'block';
                setTimeout(() => document.getElementById('cheatAlert').style.display = 'none', 3000);
            }
        });

        function triggerSecurityCheck() {
            vid.pause();
            const num1 = Math.floor(Math.random() * 10) + 1;
            const num2 = Math.floor(Math.random() * 10) + 1;
            correctAnswer = num1 + num2;
            document.getElementById('mathQ').innerText = `${toPersianNum(num1)} + ${toPersianNum(num2)} = ØŸ`;
            document.getElementById('mathAns').value = "";
            document.getElementById('mathAns').classList.remove('wrong-ans');
            document.getElementById('securityModal').style.display = 'flex';
            let timeLeft = ANSWER_TIMEOUT;
            const timerDisplay = document.getElementById('timerDisplay');
            timerDisplay.innerText = toPersianNum(timeLeft);
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.innerText = toPersianNum(timeLeft);
                if(timeLeft <= 0) { clearInterval(timerInterval); punishUser(); }
            }, 1000);
        }

        function punishUser() {
            document.getElementById('securityModal').style.display = 'none';
            alert("â° Ø²Ù…Ø§Ù† ØªÙ…Ø§Ù… Ø´Ø¯! ÙÛŒÙ„Ù… Ø§Ø² Ø§ÙˆÙ„ Ø´Ø±ÙˆØ¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯.");
            vid.currentTime = 0; maxTime = 0; nextCheckTime = CHECK_INTERVAL;
            localStorage.setItem(`${DB_KEY}${user}_time_${activeVid.id}`, 0);
            localStorage.setItem(`${DB_KEY}${user}_${activeVid.id}`, 0);
            document.getElementById('progressBar').style.width = "0%";
            document.getElementById('viewPercent').innerText = "Û°Ùª";
            lastActivityTime = Date.now(); 
        }

        function checkSecurityAnswer() {
            const rawVal = document.getElementById('mathAns').value;
            const userAns = parseInt(toEnglishNum(rawVal));
            if(userAns === correctAnswer) {
                clearInterval(timerInterval);
                document.getElementById('securityModal').style.display = 'none';
                nextCheckTime = vid.currentTime + CHECK_INTERVAL; 
                vid.play();
                lastActivityTime = Date.now(); 
            } else { document.getElementById('mathAns').classList.add('wrong-ans'); }
        }

        function checkAndReport(statusOverride, force = false) {
            if(!activeVid) return;
            let pText = document.getElementById('viewPercent').innerText;
            const percent = parseInt(toEnglishNum(pText).replace('Ùª', ''));
            if(!force && (percent < 10 || percent === lastReportedPercent)) return;
            if(!force) lastReportedPercent = percent;

            const data = {
                studentName: user,
                lesson: activeVid.title,
                status: statusOverride || "Ø¯Ø± Ø­Ø§Ù„ Ù…Ø´Ø§Ù‡Ø¯Ù‡ ğŸ‘€",
                percent: percent + "%",
                deviceInfo: getDeviceInfo(),
                timestamp: Date.now()
            };

            addToQueue(data);
            processOfflineQueue();
        }

        function addToQueue(data) {
            let queue = JSON.parse(localStorage.getItem(DB_KEY + 'offline_queue') || "[]");
            queue.push(data);
            localStorage.setItem(DB_KEY + 'offline_queue', JSON.stringify(queue));
            updateOfflineBadge(queue.length);
        }

        function processOfflineQueue() {
            let queue = JSON.parse(localStorage.getItem(DB_KEY + 'offline_queue') || "[]");
            if(queue.length === 0) { updateOfflineBadge(0); return; }

            if (!navigator.onLine) {
                updateOfflineBadge(queue.length);
                return;
            }

            const item = queue[0];
            
            fetch(REPORT_WEBAPP_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify(item),
                headers: { 'Content-Type': 'text/plain' }
            })
            .then(() => {
                queue.shift(); 
                localStorage.setItem(DB_KEY + 'offline_queue', JSON.stringify(queue));
                updateOfflineBadge(queue.length);
                if(queue.length > 0) processOfflineQueue(); 
            })
            .catch(err => {
                console.log("Send failed, keeping in queue.");
            });
        }

        function updateOfflineBadge(count) {
            const badge = document.getElementById('offlineBadge');
            if(count > 0) {
                badge.style.display = 'block';
                badge.innerText = `ğŸ“¡ ${toPersianNum(count)} Ú¯Ø²Ø§Ø±Ø´ Ø¯Ø± ØµÙ Ø§Ø±Ø³Ø§Ù„... (Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø§ÛŒÙ†ØªØ±Ù†Øª)`;
                badge.style.background = navigator.onLine ? "#f39c12" : "#c0392b"; 
            } else {
                badge.style.display = 'none';
            }
        }
    </script>
</body>
</html>
