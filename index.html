<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…ÛŒØ² Ù…Ø·Ø§Ù„Ø¹Ù‡ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ú†Ù…Ø±Ø§Ù†</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" />
    <style>
        /* --- Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ Ùˆ Ø±Ù†Ú¯â€ŒØ¨Ù†Ø¯ÛŒ --- */
        :root { --primary: #2c3e50; --accent: #d35400; --bg: #ecf0f1; --success: #27ae60; --danger: #c0392b; }
        body { font-family: 'Vazirmatn', sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 10px; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        /* Ú©Ø§Ø±Øª Ø§ØµÙ„ÛŒ */
        .card { background: white; width: 100%; max-width: 500px; padding: 25px 20px; border-radius: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); margin-top: 15px; text-align: center; display: none; }
        .active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ Ù„ÛŒØ³Øª ÙÛŒÙ„Ù… */
        .video-item { background: #fff; border: 2px solid #f1f2f6; border-radius: 15px; margin-bottom: 15px; padding: 15px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: all 0.2s; text-align: right; }
        .video-item:active { transform: scale(0.98); border-color: var(--accent); }
        .video-item.done { border-color: var(--success); background: #f0fdf4; }
        .video-icon { font-size: 1.5rem; background: #f1f2f6; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; border-radius: 12px; color: var(--primary); }
        
        /* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ùˆ ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ */
        .logout-btn { font-size: 0.75rem; color: var(--danger); background: #ffebee; padding: 4px 10px; border-radius: 8px; cursor: pointer; border: 1px solid var(--danger); display: inline-block; margin-top: 5px; }
        input { width: 100%; padding: 15px; margin: 20px 0; border: 2px solid #dfe6e9; border-radius: 15px; text-align: center; font-family: inherit; font-size: 1rem; outline: none; box-sizing: border-box; }
        input:focus { border-color: var(--accent); }
        .btn-main { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 15px; cursor: pointer; width: 100%; font-family: inherit; font-size: 1.1rem; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        
        /* Ù¾Ù„ÛŒØ± ÙˆÛŒØ¯ÛŒÙˆ */
        video { width: 100%; border-radius: 15px; background: #000; margin-top: 15px; max-height: 70vh; }
        .alert-box { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #c0392b; color: white; padding: 10px 20px; border-radius: 30px; z-index: 9999; display: none; font-size: 0.9rem; width: max-content; }
        .progress-bar { width: 100%; background: #dfe6e9; height: 8px; border-radius: 4px; margin-top: 15px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }
        .back-btn { background: #f1f2f6; border: none; padding: 8px 15px; border-radius: 10px; color: #636e72; cursor: pointer; font-family: inherit; }
        
        /* Ù…ÙˆØ¯Ø§Ù„ Ø³ÙˆØ§Ù„ Ø§Ù…Ù†ÛŒØªÛŒ */
        #securityModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .security-box { background: white; padding: 30px; border-radius: 20px; width: 85%; max-width: 400px; text-align: center; border: 4px solid var(--primary); }
        .math-question { font-size: 2rem; font-weight: bold; color: var(--primary); margin: 20px 0; direction: ltr; font-family: 'Vazirmatn', sans-serif; }
        .wrong-ans { border-color: red !important; background: #ffebee; }
        .timer-circle { width: 70px; height: 70px; background: var(--danger); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; font-weight: bold; margin: 0 auto 10px auto; border: 4px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.2); padding-top: 5px; }
        
        /* Ù„ÙˆØ¯ÛŒÙ†Ú¯ Ùˆ Ø®Ø·Ø§ */
        #loading { margin-top: 20px; display:none; color: #7f8c8d; }
        .retry-btn { margin-top: 10px; background: #95a5a6; font-size: 0.9rem; padding: 10px 20px; }
    </style>
</head>
<body>

    <div id="cheatAlert" class="alert-box">â›” Ø¬Ù„Ùˆ Ø²Ø¯Ù† ÙÛŒÙ„Ù… Ù…Ø¬Ø§Ø² Ù†ÛŒØ³Øª!</div>

    <div id="securityModal">
        <div class="security-box">
            <div id="timerDisplay" class="timer-circle">Û¶Û°</div>
            <h3>ğŸ”’ Ø­Ø¶ÙˆØ± ØºÛŒØ§Ø¨ Ù‡ÙˆØ´Ù…Ù†Ø¯</h3>
            <p style="font-size: 0.9rem; color: #555;">Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ø§Ù…Ù‡ØŒ Ø­Ø§ØµÙ„ Ø¬Ù…Ø¹ Ø²ÛŒØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:</p>
            <div id="mathQ" class="math-question">...</div>
            <input type="tel" id="mathAns" placeholder="Ù¾Ø§Ø³Ø®ØŸ">
            <button class="btn-main" onclick="checkSecurityAnswer()">Ø«Ø¨Øª Ù¾Ø§Ø³Ø® âœ…</button>
        </div>
    </div>

    <div id="screen-login" class="card">
        <div style="font-size: 4rem; margin-bottom: 10px;">ğŸ“</div>
        <h2>Ú©Ù„Ø§Ø³ Ù…Ø¬Ø§Ø²ÛŒ Ú†Ù…Ø±Ø§Ù†</h2>
        <p style="color: #7f8c8d;">Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯:</p>
        <input type="text" id="inpName" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ù…Ø¯ Ø§Ø­Ù…Ø¯ÛŒ">
        <button class="btn-main" onclick="login()">ÙˆØ±ÙˆØ¯</button>
        
        <div id="loading">
            <p>â³ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø¯Ø±Ø³â€ŒÙ‡Ø§ Ø§Ø² Ù¾Ù†Ù„...</p>
        </div>
        <div id="error-msg" style="display:none; color:#c0392b; margin-top:10px;">
            <p>Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ù¾Ù†Ù„!</p>
            <button class="btn-main retry-btn" onclick="location.reload()">ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯ ğŸ”„</button>
        </div>
    </div>

    <div id="screen-library" class="card">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px; border-bottom: 2px solid #f1f2f6; padding-bottom: 15px;">
            <div style="text-align: right;">
                <h3 style="margin:0;">Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ Ù…Ù†</h3>
                <span id="displayName" style="font-size: 0.8rem; color: var(--accent); font-weight: bold;"></span>
            </div>
            <div class="logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬ ğŸšª</div>
        </div>
        <div id="video-list-container"></div>
    </div>

    <div id="screen-player" class="card">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <button class="back-btn" onclick="backToLib()">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
            <strong id="videoTitle" style="font-size: 0.9rem;"></strong>
        </div>
        <video id="myVideo" playsinline controls controlsList="nodownload"></video>
        <div class="progress-bar"><div id="progressBar" class="progress-fill"></div></div>
        <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.8rem;">
            <span id="viewPercent" style="color: var(--accent); font-weight: bold;">Û°Ùª</span>
            <span id="viewStatus" style="color: #95a5a6;">Ø¯Ø± Ø­Ø§Ù„ ØªÙ…Ø§Ø´Ø§...</span>
        </div>
    </div>

    <script>
        // ***********************************************
        // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø¹Ù„Ù…
        // ***********************************************
        const TEACHER_EMAIL = "mpakzad529@gmail.com"; 
        
        // ØªÙ†Ø¸ÛŒÙ… Ø²Ù…Ø§Ù† Ú†Ú© Ú©Ø±Ø¯Ù† Ø³ÙˆØ§Ù„ (Û³Û°Û° Ø«Ø§Ù†ÛŒÙ‡ = Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡)
        const CHECK_INTERVAL = 300; 
        
        // Ù…Ù‡Ù„Øª Ù¾Ø§Ø³Ø®Ú¯ÙˆÛŒÛŒ Ø¨Ù‡ Ø³ÙˆØ§Ù„ (Û¶Û° Ø«Ø§Ù†ÛŒÙ‡)
        const ANSWER_TIMEOUT = 60;

        // Ù„ÛŒÙ†Ú© Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ú¯ÙˆÚ¯Ù„ Ø´ÛŒØª Ø´Ù…Ø§ (Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª)
        const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT5s2fIjXBtYnihTmXQNnvwfv3kUdGuwMdRkG6mTR1t4eCUxoOsYdJnRaucOlQlLlL1xJACckhfKBHh/pub?output=csv";
        
        // ***********************************************

        // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…
        let playlist = []; 
        const DB_KEY = "chamran_db_v9_"; // Ø¯ÛŒØªØ§Ø¨ÛŒØ³
        let user = "";
        let activeVid = null;
        let maxTime = 0;
        let isDone = false;
        let lastReportedPercent = 0;
        let nextCheckTime = CHECK_INTERVAL;
        let correctAnswer = 0;
        let timerInterval = null;
        const vid = document.getElementById('myVideo');

        // ØªÙˆØ§Ø¨Ø¹ ØªØ¨Ø¯ÛŒÙ„ Ø§Ø¹Ø¯Ø§Ø¯ (ÙØ§Ø±Ø³ÛŒ/Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ)
        function toPersianNum(n) { return n.toString().replace(/\d/g, x => ['Û°','Û±','Û²','Û³','Û´','Ûµ','Û¶','Û·','Û¸','Û¹'][x]); }
        function toEnglishNum(s) { return s.replace(/[Û°-Û¹]/g, d => "Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹".indexOf(d)); }

        // --- Ø¨Ø®Ø´ Û±: Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø² Ú¯ÙˆÚ¯Ù„ Ø´ÛŒØª ---
        async function fetchPlaylist() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error-msg').style.display = 'none';
            
            try {
                // Ø¯Ø±ÛŒØ§ÙØª CSV Ø¨Ø§ Ù¾Ø§Ø±Ø§Ù…ØªØ± Ø²Ù…Ø§Ù† Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ú©Ø´
                const res = await fetch(SHEET_CSV_URL + '&t=' + Date.now());
                if(!res.ok) throw new Error("Network error");
                
                const data = await res.text();
                parseCSV(data); // ØªØ¨Ø¯ÛŒÙ„ CSV Ø¨Ù‡ Ù„ÛŒØ³Øª
                
                document.getElementById('loading').style.display = 'none';
                
                // Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§ Ù„Ø§Ú¯ÛŒÙ† Ú©Ø±Ø¯Ù‡ØŒ Ù…Ø³ØªÙ‚ÛŒÙ… ÙˆØ§Ø±Ø¯ Ø´ÙˆØ¯
                const savedName = localStorage.getItem(DB_KEY + 'name');
                if(savedName) {
                    user = savedName;
                    document.getElementById('displayName').innerText = user;
                    renderList();
                    showScreen('screen-library');
                } else {
                    showScreen('screen-login');
                }
            } catch (err) {
                console.error(err);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error-msg').style.display = 'block';
            }
        }

        // ØªØ¨Ø¯ÛŒÙ„ Ù…ØªÙ† CSV Ø¨Ù‡ Ø¢Ø±Ø§ÛŒÙ‡ Ø¬Ø§ÙˆØ§Ø§Ø³Ú©Ø±ÛŒÙ¾Øª
        function parseCSV(csvText) {
            playlist = [];
            const rows = csvText.split('\n');
            for(let i=1; i<rows.length; i++) {
                const row = rows[i].split(',');
                if(row.length >= 3) {
                    const id = row[0].trim();
                    const title = row[1].trim(); 
                    const file = row[2].trim(); 
                    if(id && title && file) {
                        playlist.push({ id, title, file });
                    }
                }
            }
        }

        // Ø§Ø¬Ø±Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø±Ù†Ø§Ù…Ù‡
        fetchPlaylist();

        // --- Ø¨Ø®Ø´ Û²: Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø± (ÙˆØ±ÙˆØ¯/Ø®Ø±ÙˆØ¬) ---
        function login() {
            const name = document.getElementById('inpName').value.trim();
            if(name.length < 3) return alert("Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ú©Ø§Ù…Ù„ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯");
            user = name;
            localStorage.setItem(DB_KEY + 'name', user);
            document.getElementById('displayName').innerText = user;
            renderList();
            showScreen('screen-library');
        }

        function logout() {
            if(confirm("Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§Ø² Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø®Ø§Ø±Ø¬ Ø´ÙˆÛŒØ¯ØŸ")) {
                localStorage.removeItem(DB_KEY + 'name');
                location.reload();
            }
        }

        // --- Ø¨Ø®Ø´ Û³: Ù†Ù…Ø§ÛŒØ´ Ù„ÛŒØ³Øª ÙˆÛŒØ¯ÛŒÙˆÙ‡Ø§ ---
        function renderList() {
            const list = document.getElementById('video-list-container');
            list.innerHTML = "";
            
            if(playlist.length === 0) {
                list.innerHTML = "<p style='text-align:center; color:#777;'>Ù‡Ù†ÙˆØ² Ø¯Ø±Ø³ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>";
                return;
            }

            playlist.forEach(item => {
                const progress = localStorage.getItem(`${DB_KEY}${user}_${item.id}`) || 0;
                const isCompleted = progress >= 98;
                const icon = isCompleted ? 'âœ…' : 'â–¶ï¸';
                
                const el = document.createElement('div');
                el.className = `video-item ${isCompleted ? 'done' : ''}`;
                el.onclick = () => playVideo(item);
                el.innerHTML = `
                    <div class="video-icon">${icon}</div>
                    <div class="video-info">
                        <h4>${item.title}</h4>
                        <span class="status-text">${isCompleted ? 'ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯' : toPersianNum(progress) + 'Ùª Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø´Ø¯Ù‡'}</span>
                    </div>
                `;
                list.appendChild(el);
            });
        }

        // --- Ø¨Ø®Ø´ Û´: Ù¾Ø®Ø´ ÙˆÛŒØ¯ÛŒÙˆ Ùˆ Ú©Ù†ØªØ±Ù„Ø±Ù‡Ø§ ---
        function playVideo(item) {
            if(!item.file || item.file.length < 5) return alert("Ù„ÛŒÙ†Ú© Ø§ÛŒÙ† ÙˆÛŒØ¯ÛŒÙˆ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.");
            
            activeVid = item;
            document.getElementById('videoTitle').innerText = item.title;
            isDone = false;
            lastReportedPercent = 0;
            vid.src = item.file;
            
            // Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø¢Ø®Ø±ÛŒÙ† Ø²Ù…Ø§Ù† Ø¯ÛŒØ¯Ù‡ Ø´Ø¯Ù‡
            const savedTime = localStorage.getItem(`${DB_KEY}${user}_time_${item.id}`);
            maxTime = savedTime ? parseFloat(savedTime) : 0;
            
            // ØªÙ†Ø¸ÛŒÙ… Ø²Ù…Ø§Ù† Ø³ÙˆØ§Ù„ Ø¨Ø¹Ø¯ÛŒ
            nextCheckTime = maxTime + CHECK_INTERVAL; 
            
            showScreen('screen-player');
            if(maxTime > 5) {
                if(confirm("Ø§Ø¯Ø§Ù…Ù‡ Ù¾Ø®Ø´ Ø§Ø² Ø¬Ø§ÛŒ Ù‚Ø¨Ù„ÛŒØŸ")) vid.currentTime = maxTime;
            }
        }

        function backToLib() {
            checkAndReportExit(); // Ú¯Ø²Ø§Ø±Ø´ Ø®Ø±ÙˆØ¬ Ù†Ø§Ù‚Øµ
            vid.pause();
            renderList();
            showScreen('screen-library');
        }

        function showScreen(id) {
            document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // --- Ø¨Ø®Ø´ Ûµ: Ø¶Ø¯ ØªÙ‚Ù„Ø¨ Ùˆ ØªØ§ÛŒÙ…Ø± ---
        vid.addEventListener('seeking', () => {
            // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø¨ÛŒØ´ØªØ± Ø§Ø² Û³ Ø«Ø§Ù†ÛŒÙ‡ Ø¬Ù„Ùˆ Ø²Ø¯
            if(vid.currentTime > maxTime + 3) {
                vid.currentTime = maxTime;
                document.getElementById('cheatAlert').style.display = 'block';
                setTimeout(() => document.getElementById('cheatAlert').style.display = 'none', 3000);
            }
        });

        vid.addEventListener('timeupdate', () => {
            // Ø°Ø®ÛŒØ±Ù‡ Ù…Ø¯Ø§ÙˆÙ… Ù¾ÛŒØ´Ø±ÙØª
            if(!vid.seeking && vid.currentTime > maxTime) {
                maxTime = vid.currentTime;
                localStorage.setItem(`${DB_KEY}${user}_time_${activeVid.id}`, maxTime);
            }
            
            // Ú†Ú© Ú©Ø±Ø¯Ù† Ø²Ù…Ø§Ù† Ø³ÙˆØ§Ù„ Ø§Ù…Ù†ÛŒØªÛŒ
            if(vid.currentTime > nextCheckTime) triggerSecurityCheck();
            
            // Ø¢Ù¾Ø¯ÛŒØª Ù†ÙˆØ§Ø± Ù¾ÛŒØ´Ø±ÙØª
            if(vid.duration) {
                const percent = Math.min(100, Math.floor((maxTime / vid.duration) * 100));
                document.getElementById('progressBar').style.width = percent + "%";
                document.getElementById('viewPercent').innerText = toPersianNum(percent) + "Ùª";
                localStorage.setItem(`${DB_KEY}${user}_${activeVid.id}`, percent);
                
                // ØªÚ©Ù…ÛŒÙ„ Ø¯Ø±Ø³
                if(percent >= 98 && !isDone) {
                    isDone = true;
                    document.getElementById('viewStatus').innerText = "ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯! âœ…";
                    sendEmailReport("ØªÚ©Ù…ÛŒÙ„ Ú©Ø§Ù…Ù„ Ø¯Ø±Ø³ âœ…", 100);
                }
            }
        });

        // --- Ø¨Ø®Ø´ Û¶: Ø³ÙˆØ§Ù„ Ø§Ù…Ù†ÛŒØªÛŒ Ùˆ ØªØ§ÛŒÙ…Ø± Ù…Ø±Ú¯ ---
        function triggerSecurityCheck() {
            vid.pause();
            
            // ØªÙˆÙ„ÛŒØ¯ Ø³ÙˆØ§Ù„ Ø±ÛŒØ§Ø¶ÛŒ ØªØµØ§Ø¯ÙÛŒ
            const num1 = Math.floor(Math.random() * 10) + 1;
            const num2 = Math.floor(Math.random() * 10) + 1;
            correctAnswer = num1 + num2;
            
            document.getElementById('mathQ').innerText = `${toPersianNum(num1)} + ${toPersianNum(num2)} = ØŸ`;
            document.getElementById('mathAns').value = "";
            document.getElementById('mathAns').classList.remove('wrong-ans');
            document.getElementById('securityModal').style.display = 'flex';
            
            // Ø´Ø±ÙˆØ¹ Ø´Ù…Ø§Ø±Ø´ Ù…Ø¹Ú©ÙˆØ³
            let timeLeft = ANSWER_TIMEOUT;
            const timerDisplay = document.getElementById('timerDisplay');
            timerDisplay.innerText = toPersianNum(timeLeft);
            
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.innerText = toPersianNum(timeLeft);
                
                // ØªØºÛŒÛŒØ± Ø±Ù†Ú¯ Ù‡Ø´Ø¯Ø§Ø±
                if(timeLeft < 10) timerDisplay.style.background = "#b71c1c";
                else timerDisplay.style.background = "#c0392b";
                
                // Ø¬Ø±ÛŒÙ…Ù‡ Ù¾Ø§ÛŒØ§Ù† ÙˆÙ‚Øª
                if(timeLeft <= 0) {
                    clearInterval(timerInterval);
                    punishUser();
                }
            }, 1000);
        }

        function punishUser() {
            document.getElementById('securityModal').style.display = 'none';
            alert("â° Ø²Ù…Ø§Ù† ØªÙ…Ø§Ù… Ø´Ø¯! Ù…ØªØ§Ø³ÙØ§Ù†Ù‡ ÙÛŒÙ„Ù… Ø§Ø² Ø§ÙˆÙ„ Ø´Ø±ÙˆØ¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯.");
            
            // Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡ Ú†ÛŒØ² Ø¨Ù‡ ØµÙØ±
            vid.currentTime = 0; 
            maxTime = 0; 
            nextCheckTime = CHECK_INTERVAL;
            localStorage.setItem(`${DB_KEY}${user}_time_${activeVid.id}`, 0);
            localStorage.setItem(`${DB_KEY}${user}_${activeVid.id}`, 0);
            document.getElementById('progressBar').style.width = "0%";
            document.getElementById('viewPercent').innerText = "Û°Ùª";
        }

        function checkSecurityAnswer() {
            const rawVal = document.getElementById('mathAns').value;
            const userAns = parseInt(toEnglishNum(rawVal)); // ØªØ¨Ø¯ÛŒÙ„ Ù¾Ø§Ø³Ø® ÙØ§Ø±Ø³ÛŒ Ø¨Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ
            
            if(userAns === correctAnswer) {
                clearInterval(timerInterval); // ØªÙˆÙ‚Ù ØªØ§ÛŒÙ…Ø±
                document.getElementById('securityModal').style.display = 'none';
                nextCheckTime = vid.currentTime + CHECK_INTERVAL; // ØªÙ†Ø¸ÛŒÙ… Ø²Ù…Ø§Ù† Ú†Ú© Ø¨Ø¹Ø¯ÛŒ
                vid.play();
            } else {
                document.getElementById('mathAns').classList.add('wrong-ans');
            }
        }

        // --- Ø¨Ø®Ø´ Û·: Ú¯Ø²Ø§Ø±Ø´â€ŒØ¯Ù‡ÛŒ Ø§ÛŒÙ…ÛŒÙ„ÛŒ ---
        window.addEventListener("visibilitychange", () => {
            if (document.visibilityState === 'hidden') checkAndReportExit();
        });
        
        function checkAndReportExit() {
            if(!activeVid || isDone) return;
            
            let pText = document.getElementById('viewPercent').innerText;
            pText = toEnglishNum(pText).replace('Ùª', '');
            const percent = parseInt(pText);
            
            // ÙÙ‚Ø· Ø§Ú¯Ø± Ù¾ÛŒØ´Ø±ÙØª Ù…Ø¹Ù‚ÙˆÙ„ÛŒ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø¯Ù‡
            if(percent > 10 && percent < 98 && percent > lastReportedPercent) {
                lastReportedPercent = percent;
                sendEmailReport("Ø®Ø±ÙˆØ¬ Ù†Ø§Ù‚Øµ (Ù†ÛŒÙ…Ù‡â€ŒÚ©Ø§Ø±Ù‡) âš ï¸", percent);
            }
        }

        function sendEmailReport(status, percent) {
            const formData = new FormData();
            formData.append("Ù…ÙˆØ¶ÙˆØ¹", `Ú¯Ø²Ø§Ø±Ø´: ${activeVid.title} - ${user}`);
            formData.append("Ù†Ø§Ù…_Ø¯Ø§Ù†Ø´_Ø¢Ù…ÙˆØ²", user);
            formData.append("Ø¯Ø±Ø³", activeVid.title);
            formData.append("ÙˆØ¶Ø¹ÛŒØª", status);
            formData.append("Ø¯Ø±ØµØ¯_Ù…Ø´Ø§Ù‡Ø¯Ù‡", percent + "%");
            formData.append("Ø²Ù…Ø§Ù†", new Date().toLocaleString('fa-IR'));
            formData.append("_captcha", "false");
            formData.append("_template", "table");
            
            // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Beacon Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù…Ø·Ù…Ø¦Ù† Ù‡Ù†Ú¯Ø§Ù… Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù† ØµÙØ­Ù‡
            const url = `https://formsubmit.co/${TEACHER_EMAIL}`;
            navigator.sendBeacon(url, formData);
        }
    </script>
</body>
</html>
