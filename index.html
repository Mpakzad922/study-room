<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…ÛŒØ² Ù…Ø·Ø§Ù„Ø¹Ù‡ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ú†Ù…Ø±Ø§Ù†</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">

    <style>
        /* --- Ú©Ø¯Ù‡Ø§ÛŒ CSS Ø§ÙˆØ±Ø¬ÛŒÙ†Ø§Ù„ Ø´Ù…Ø§ (Ø­ÙØ¸ Ø´Ø¯Ù‡) --- */
        :root { --primary: #2c3e50; --accent: #e67e22; --bg: #ecf0f1; --success: #27ae60; --danger: #c0392b; --gold: linear-gradient(45deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c); }
        body { font-family: 'Vazirmatn', sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 10px; box-sizing: border-box; -webkit-tap-highlight-color: transparent; overflow-x: hidden; user-select: none; }
        
        .card { background: white; width: 100%; max-width: 500px; padding: 25px 20px; border-radius: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); margin-top: 15px; text-align: center; display: none; opacity: 0; transition: opacity 0.5s ease-in-out; }
        .card.show-content { opacity: 1; }
        .active { display: block; }

        .user-panel { background: #2c3e50; color: white; padding: 15px; border-radius: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 5px 15px rgba(44, 62, 80, 0.3); position: relative; overflow: hidden; }
        .user-panel::after { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent, rgba(255,255,255,0.05), transparent); animation: shinePanel 5s infinite; }
        @keyframes shinePanel { 0% {transform: translateX(-100%);} 100% {transform: translateX(100%);} }
        .rank-badge { background: rgba(255,255,255,0.2); padding: 3px 10px; border-radius: 8px; font-size: 0.75rem; margin-top: 5px; display: inline-block; }
        
        .video-item { background: #fff; border: 2px solid #f1f2f6; border-radius: 15px; margin-bottom: 15px; padding: 15px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: all 0.2s; text-align: right; }
        .video-item:active { transform: scale(0.98); border-color: var(--accent); }
        .video-item.done { border-color: var(--success); background: #f0fdf4; }
        .video-icon { font-size: 1.5rem; background: #f1f2f6; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; border-radius: 12px; color: var(--primary); }
        
        .logout-btn { font-size: 0.75rem; color: var(--danger); background: #ffebee; padding: 4px 10px; border-radius: 8px; cursor: pointer; border: 1px solid var(--danger); display: inline-block; margin-top: 5px; }
        input { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #dfe6e9; border-radius: 15px; text-align: center; font-family: 'Montserrat', 'Vazirmatn'; font-size: 1.1rem; outline: none; box-sizing: border-box; }
        input:focus { border-color: var(--accent); }
        .btn-main { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 15px; cursor: pointer; width: 100%; font-family: inherit; font-size: 1.1rem; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2); margin-top: 10px; }
        .btn-loading { opacity: 0.7; cursor: wait; }

        /* --- ğŸ› ï¸ ØªØºÛŒÛŒØ±Ø§Øª Ù…Ù‡Ù… Ø¨Ø±Ø§ÛŒ Ù¾Ù„ÛŒØ± Ø¬Ø¯ÛŒØ¯ Ùˆ ØªÙ…Ø§Ù… ØµÙØ­Ù‡ (NEW) --- */
        /* Ø§ÛŒÙ† Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ø§Ø³ØªØ§ÛŒÙ„ Ù‚Ø¨Ù„ÛŒ ÙˆÛŒØ¯ÛŒÙˆ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ */
        #playerContainer {
            position: relative; width: 100%; background: #000; border-radius: 15px; overflow: hidden; display: flex; flex-direction: column; justify-content: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); aspect-ratio: 16/9;
        }
        /* ÙˆÙ‚ØªÛŒ ØªÙ…Ø§Ù… ØµÙØ­Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ */
        #playerContainer:fullscreen { width: 100vw; height: 100vh; border-radius: 0; aspect-ratio: unset; }
        #playerContainer:fullscreen video { height: 100%; width: 100%; object-fit: contain; }
        
        video { width: 100%; height: 100%; outline: none; background: #000; }

        /* Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ÛŒ Ø³ÙØ§Ø±Ø´ÛŒ (Ø¨Ø±Ø§ÛŒ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø±ÙˆØ±Ú¯Ø±) */
        .custom-controls {
            position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); padding: 10px 15px; box-sizing: border-box; display: flex; align-items: center; gap: 15px; transition: opacity 0.3s; opacity: 1; z-index: 20; direction: ltr;
        }
        .fade-out { opacity: 0 !important; pointer-events: none; }
        .c-btn { background: none; border: none; color: white; cursor: pointer; font-size: 1.4rem; padding: 5px; text-shadow: 0 0 5px rgba(0,0,0,0.5); transition: 0.2s; }
        .c-btn:hover { color: var(--accent); transform: scale(1.1); }
        .progress-bar-container { flex: 1; background: rgba(255,255,255,0.3); height: 6px; border-radius: 10px; cursor: default; position: relative; overflow: hidden; }
        .progress-fill { background: var(--accent); height: 100%; width: 0%; border-radius: 10px; transition: width 0.2s linear; box-shadow: 0 0 10px var(--accent); }

        /* Ù…ÙˆØ¯Ø§Ù„ Ø§Ù…Ù†ÛŒØªÛŒ Ø³ÙˆØ§Ù„ Ø±ÛŒØ§Ø¶ÛŒ (Ø¯Ø§Ø®Ù„ Ù¾Ù„ÛŒØ±) */
        #securityModal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 50; display: none; justify-content: center; align-items: center; flex-direction: column; color: white; backdrop-filter: blur(5px); }
        .security-box { background: transparent; padding: 0; width: auto; max-width: none; text-align: center; border: none; }
        .timer-circle { width: 80px; height: 80px; background: transparent; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.2rem; font-weight: bold; margin: 0 auto 20px auto; border: 5px solid var(--danger); box-shadow: 0 0 20px var(--danger); animation: pulseTimer 1s infinite; }
        @keyframes pulseTimer { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .math-question { font-size: 2.5rem; font-weight: bold; color: var(--accent); margin: 20px 0; direction: ltr; font-family: 'Vazirmatn', sans-serif; text-shadow: 0 0 10px black; }
        
        /* Ø³Ø§ÛŒØ± Ø§Ø¬Ø²Ø§ */
        .alert-box { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: #c0392b; color: white; padding: 10px 20px; border-radius: 30px; z-index: 100; display: none; font-size: 0.9rem; width: max-content; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .back-btn { background: #f1f2f6; border: none; padding: 8px 15px; border-radius: 10px; color: #636e72; cursor: pointer; font-family: inherit; font-weight:bold; }
        
        #downloadContainer { margin-top: 20px; display: grid; gap: 10px; }
        .download-btn { background: #fff; color: #34495e; text-decoration: none; padding: 12px 15px; border-radius: 12px; font-size: 0.9rem; display: flex; align-items: center; justify-content: space-between; border: 2px solid #ecf0f1; transition: 0.3s; }
        .dl-icon { font-size: 1.2rem; margin-left: 10px; }
        .dl-text { font-weight: bold; }
        .dl-arrow { color: var(--accent); font-size: 0.8rem; }

        .spinner { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db; width: 30px; height: 30px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #loading { margin-top: 20px; display:none; color: #7f8c8d; }
        
        .offline-badge { position:fixed; bottom:10px; left:10px; background:orange; color:white; padding:8px 15px; border-radius:30px; font-size:0.8rem; display:none; z-index:2000; box-shadow: 0 4px 10px rgba(0,0,0,0.2); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø¢ØªØ´ Ø¨Ø§Ø²ÛŒ */
        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; display: none; }

        /* ØµÙØ­Ù‡ Ù„ÙˆØ¯ÛŒÙ†Ú¯ Ùˆ Ø§Ù…Ø¶Ø§ */
        #intro-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 5000; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: all 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        #intro-overlay.move-down { top: 85%; transform: scale(0.6); opacity: 0; pointer-events: none; }
        .signature-container { text-align: center; direction: ltr; }
        .sig-prefix { font-family: 'Montserrat', sans-serif; font-size: 0.9rem; color: #7f8c8d; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 5px; }
        .sig-name { font-family: 'Cinzel Decorative', cursive; font-size: 2.5rem; font-weight: 700; background: var(--gold); -webkit-background-clip: text; -webkit-text-fill-color: transparent; position: relative; display: inline-block; padding: 5px; }
        .sig-name::after { content: attr(data-text); position: absolute; left: 0; top: 0; padding: 5px; z-index: -1; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.8), transparent); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-size: 200%; background-position: -100%; animation: shine 4s infinite linear; }
        @keyframes shine { to { background-position: 200%; } }
        .footer-signature { margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(0,0,0,0.05); opacity: 0; transition: opacity 2s ease; }
        .footer-signature.show { opacity: 1; }
        .footer-signature .sig-name { font-size: 1.5rem; } 
        .footer-signature .sig-prefix { font-size: 0.7rem; }

        #syncOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 20000; display: none; flex-direction: column; justify-content: center; align-items: center; color: white; backdrop-filter: blur(5px); }
        .hourglass-spinner { font-size: 4rem; margin-bottom: 20px; animation: spinHourglass 2s infinite ease-in-out; text-shadow: 0 0 20px rgba(255,255,255,0.5); }
        @keyframes spinHourglass { 0% { transform: rotate(0deg); } 50% { transform: rotate(180deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <canvas id="confetti-canvas"></canvas>

    <div id="intro-overlay">
        <div class="signature-container">
            <div class="sig-prefix">Created By</div>
            <div class="sig-name" data-text="Mohammad Pakzad">Mohammad Pakzad</div>
        </div>
    </div>

    <div id="syncOverlay">
        <div class="hourglass-spinner">â³</div>
        <h3 style="font-family: 'Vazirmatn'; margin:0;">Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ø³Ø±ÙˆØ±...</h3>
        <p style="font-size:0.8rem; color:#bdc3c7; margin-top:5px;">Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯</p>
    </div>

    <div id="offlineBadge" class="offline-badge"></div>

    <div id="screen-login" class="card">
        <div style="font-size: 4rem; margin-bottom: 10px;">ğŸ“</div>
        <h2>Ú©Ù„Ø§Ø³ Ù…Ø¬Ø§Ø²ÛŒ Ú†Ù…Ø±Ø§Ù†</h2>
        <p style="color: #7f8c8d; font-size: 0.9rem;">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ùˆ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</p>
        
        <input type="text" id="inpUser" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ (Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ)" style="direction: ltr;">
        <input type="tel" id="inpPass" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± (Ø¹Ø¯Ø¯)" style="direction: ltr;">
        
        <button id="btnLogin" class="btn-main" onclick="performLogin()">ÙˆØ±ÙˆØ¯ Ø§Ù…Ù† ğŸ”</button>
        <div id="loginMsg" style="margin-top:15px; color:#c0392b; font-size:0.9rem;"></div>
        
        <div id="loading"><p>â³ Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±...</p></div>
        
        <div class="signature-container footer-signature" id="loginFooterSig">
            <div class="sig-prefix">Created By</div>
            <div class="sig-name" data-text="Mohammad Pakzad">Mohammad Pakzad</div>
        </div>
    </div>

    <div id="screen-library" class="card">
        <div class="user-panel">
            <div>
                <div id="displayName" style="font-weight:bold; font-size:1.1rem;">Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</div>
                <div id="user-rank" class="rank-badge">ØªØ§Ø²Ù‡â€ŒÙˆØ§Ø±Ø¯</div>
            </div>
            <div style="text-align:center;">
                <div style="font-size:1.5rem;">â­</div>
                <div id="user-xp" style="font-size:0.9rem;">0 XP</div>
            </div>
        </div>

        <div style="margin-bottom: 20px;">
            <button onclick="window.location.href='azmoon.html'" style="background: #8e44ad; color: white; border: none; padding: 15px; border-radius: 15px; width: 100%; font-family: inherit; font-size: 1.1rem; cursor: pointer; box-shadow: 0 4px 10px rgba(142, 68, 173, 0.3);">
                ğŸ“ ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¢Ø²Ù…ÙˆÙ† Ø¢Ù†Ù„Ø§ÛŒÙ†
            </button>
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom:10px;">
            <h3 style="margin:0;">Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ Ù…Ù†</h3>
            <div class="logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬ ğŸšª</div>
        </div>

        <div id="video-list-container"></div>
        
        <div class="signature-container footer-signature show" style="margin-top: 10px; border:none;">
            <div class="sig-name" data-text="M. Pakzad" style="font-size: 1rem;">M. Pakzad</div>
        </div>
    </div>

    <div id="screen-player" class="card" style="padding:0; background:transparent; box-shadow:none; max-width:800px;">
        <div id="playerContainer">
            
            <div id="cheatAlert" class="alert-box">â›” Ø¬Ù„Ùˆ Ø²Ø¯Ù† ÙÛŒÙ„Ù… Ù…Ø¬Ø§Ø² Ù†ÛŒØ³Øª!</div>

            <div id="securityModal">
                <div id="timerDisplay" class="timer-circle">Û¶Û°</div>
                <h3>ğŸ”’ Ø­Ø¶ÙˆØ± ØºÛŒØ§Ø¨ Ù‡ÙˆØ´Ù…Ù†Ø¯</h3>
                <p style="font-size: 0.9rem; color: #fff;">Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ø§Ù…Ù‡ØŒ Ø­Ø§ØµÙ„ Ø¬Ù…Ø¹ Ø²ÛŒØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:</p>
                <div id="mathQ" class="math-question">...</div>
                <input type="tel" id="mathAns" placeholder="Ù¾Ø§Ø³Ø®ØŸ" style="width: 150px; color:black; background: rgba(255,255,255,0.9);">
                <button class="btn-main" onclick="checkSecurityAnswer()" style="width: 150px; background:white; color:var(--primary);">Ø«Ø¨Øª Ù¾Ø§Ø³Ø® âœ…</button>
            </div>

            <video id="myVideo" playsinline disablePictureInPicture></video>

            <div class="custom-controls" id="controlsBar">
                <button class="c-btn" id="playBtn" onclick="togglePlay()">â–¶ï¸</button>
                <div class="progress-bar-container">
                    <div id="progressBar" class="progress-fill"></div>
                </div>
                <span id="timeDisplay" style="color:white; font-size:0.8rem; margin:0 10px;">00:00</span>
                <button class="c-btn" onclick="toggleFullScreen()" title="ØªÙ…Ø§Ù… ØµÙØ­Ù‡">â›¶</button>
            </div>
        </div>

        <div style="padding: 15px; background: white; border-radius: 0 0 20px 20px; position:relative; z-index:10; box-shadow: 0 8px 20px rgba(0,0,0,0.05);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <button class="back-btn" onclick="closePlayer()">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
                <strong id="videoTitle" style="font-size: 0.9rem;">Ø¹Ù†ÙˆØ§Ù† Ø¯Ø±Ø³</strong>
            </div>
            <div id="downloadContainer"></div>
            <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.8rem;">
                <span id="viewPercent" style="color: var(--accent); font-weight: bold;">Û°Ùª</span>
                <span id="viewStatus" style="color: #95a5a6;">Ø¯Ø± Ø­Ø§Ù„ ØªÙ…Ø§Ø´Ø§...</span>
            </div>
        </div>
    </div>

    <script src="rank.js" onerror="alert('ÙØ§ÛŒÙ„ rank.js ÛŒØ§ÙØª Ù†Ø´Ø¯!')"></script>

    <script>
        // ***********************************************
        // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ØµÙ„ÛŒ
        // ***********************************************
        const API_URL = "https://chamran-api.liara.run";
        const CHECK_INTERVAL = 300; 
        const ANSWER_TIMEOUT = 60;
        const IDLE_TIMEOUT = 120;
        const DB_KEY = "chamran_db_vfinal_";
        
        let playlist = []; 
        let currentUser = null;
        let activeVid = null;
        let maxTime = 0;
        let isDone = false;
        let nextCheckTime = CHECK_INTERVAL;
        let correctAnswer = 0;
        let timerInterval = null;
        let lastActivityTime = Date.now();
        let idleReportSent = false;
        let backgroundTimer = null;
        let cheatAttempts = 0;
        let cheatResetTimer = null;
        let isSystemSeeking = false; 

        const vid = document.getElementById('myVideo');
        const container = document.getElementById('playerContainer');

        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('intro-overlay').classList.add('move-down');
                document.querySelectorAll('.card').forEach(c => c.classList.add('show-content'));
                document.getElementById('loginFooterSig').classList.add('show');
                setTimeout(() => {
                    document.getElementById('intro-overlay').style.display = 'none';
                    checkAuth();
                }, 1200);
            }, 2500);
        });

        function toPersianNum(n) { return n.toString().replace(/\d/g, x => ['Û°','Û±','Û²','Û³','Û´','Ûµ','Û¶','Û·','Û¸','Û¹'][x]); }
        function toEnglishNum(s) { return s.replace(/[Û°-Û¹]/g, d => "Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹".indexOf(d)); }
        function getDeviceInfo() { return /Mobile|Android/i.test(navigator.userAgent) ? "ğŸ“± Mobile" : "ğŸ’» PC"; }

        // --- Auth Logic ---
        async function checkAuth() {
            const savedUser = localStorage.getItem(DB_KEY + 'creds');
            if(savedUser) {
                try {
                    const creds = JSON.parse(savedUser);
                    // Ù„ÙˆØ¯ÛŒÙ†Ú¯ Ù…Ø®ÙÛŒ Ù‡Ù†Ú¯Ø§Ù… Ú†Ú© Ú©Ø±Ø¯Ù†
                    document.getElementById('intro-overlay').style.display = 'flex';
                    document.querySelector('.sig-name').innerHTML = "Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...";
                    
                    const res = await fetch(API_URL, {
                        method: 'POST', headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ action: 'login', username: creds.username, password: creds.password })
                    });
                    const data = await res.json();
                    
                    if(data.status === 'success') {
                        currentUser = { username: creds.username, password: creds.password, displayName: data.displayName, jsonData: data.jsonData };
                        if(typeof SyncManager !== 'undefined') SyncManager.init(creds.username, creds.password);
                        if(typeof RankSystem !== 'undefined') RankSystem.init(data.jsonData);
                        document.getElementById('displayName').innerText = data.displayName;
                        document.getElementById('intro-overlay').style.display = 'none';
                        showScreen('screen-library');
                        fetchPlaylist();
                    } else {
                        localStorage.removeItem(DB_KEY + 'creds');
                        document.getElementById('intro-overlay').style.display = 'none';
                        showScreen('screen-login');
                    }
                } catch(e) {
                    // Ø¢ÙÙ„Ø§ÛŒÙ† ÛŒØ§ Ø®Ø·Ø§
                    document.getElementById('intro-overlay').style.display = 'none';
                    showScreen('screen-login');
                }
            } else {
                showScreen('screen-login');
            }
        }

        async function performLogin() {
            const u = document.getElementById('inpUser').value.trim();
            const p = document.getElementById('inpPass').value.trim();
            const btn = document.getElementById('btnLogin');
            const msg = document.getElementById('loginMsg');
            
            if(!u || !p) return msg.innerText = "Ù„Ø·ÙØ§ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ùˆ Ø±Ù…Ø² Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯";
            
            btn.classList.add('btn-loading');
            btn.innerText = "Ø¯Ø±Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ...";
            msg.innerText = "";

            try {
                const res = await fetch(API_URL, {
                    method: 'POST', headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ action: 'login', username: u, password: p })
                });
                const data = await res.json();
                
                if(data.status === 'success') {
                    const userData = { username: u, password: p, displayName: data.displayName, jsonData: data.jsonData };
                    localStorage.setItem(DB_KEY + 'creds', JSON.stringify(userData));
                    currentUser = userData;
                    
                    if(typeof SyncManager !== 'undefined') SyncManager.init(u, p);
                    if(typeof RankSystem !== 'undefined') RankSystem.init(data.jsonData);
                    
                    document.getElementById('displayName').innerText = data.displayName;
                    showScreen('screen-library');
                    fetchPlaylist();
                } else {
                    msg.innerText = data.message || "Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯";
                }
            } catch(e) {
                console.error(e);
                msg.innerText = "Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±.";
            }
            btn.classList.remove('btn-loading');
            btn.innerText = "ÙˆØ±ÙˆØ¯ Ø§Ù…Ù† ğŸ”";
        }

        function logout() {
            if(confirm("Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒØŸ")) {
                localStorage.removeItem(DB_KEY + 'creds');
                location.reload();
            }
        }

        function showScreen(id) {
            document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
            const target = document.getElementById(id);
            target.classList.add('active');
            setTimeout(() => target.classList.add('show-content'), 50);
        }

        // --- Library Logic ---
        async function fetchPlaylist() {
            const listContainer = document.getElementById('video-list-container');
            listContainer.innerHTML = `<div style="text-align:center; padding:20px;"><div class="spinner" style="margin:0 auto;"></div><p style="color:#7f8c8d; margin-top:10px;">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø±Ø³â€ŒÙ‡Ø§...</p></div>`;
            try {
                const res = await fetch(API_URL, {
                    method: 'POST', headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ action: 'get_lessons' }) 
                });
                const result = await res.json();
                if(result.status === 'success') {
                    playlist = result.data;
                    renderList();
                } else { throw new Error("Server Error"); }
            } catch (err) { 
                listContainer.innerHTML = `<div style="text-align:center; padding:20px; color:#c0392b;"><p>âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø±Ø³â€ŒÙ‡Ø§</p><button onclick="fetchPlaylist()" style="background:#2c3e50; color:white; border:none; padding:10px 20px; border-radius:10px; cursor:pointer; margin-top:10px;">ğŸ”„ ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯</button></div>`;
            }
        }

        function renderList() {
            const list = document.getElementById('video-list-container');
            list.innerHTML = "";
            if(!playlist || playlist.length === 0) {
                list.innerHTML = "<p style='text-align:center;'>ğŸ“­ Ø¯Ø±Ø³ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>";
                return;
            }
            playlist.forEach(item => {
                const isCompleted = RankSystem.data.completed.includes(item.id.toString());
                const icon = isCompleted ? 'âœ…' : 'â–¶ï¸';
                const hasFile = (item.attachment && item.attachment.length > 3);
                const el = document.createElement('div');
                el.className = `video-item ${isCompleted ? 'done' : ''}`;
                el.onclick = () => playVideo(item);
                el.innerHTML = `<div class="video-icon">${icon}</div><div class="video-info"><h4>${item.title}</h4><div style="font-size:0.8rem; color:#7f8c8d;">${isCompleted ? 'ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯' : 'Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯'}${hasFile ? ' | ğŸ“ ÙØ§ÛŒÙ„ Ø¶Ù…ÛŒÙ…Ù‡' : ''}</div></div>`;
                list.appendChild(el);
            });
        }

        // --- Player Logic (NEW & IMPROVED) ---
        function playVideo(item) {
            history.pushState({ page: 'player' }, "Player", "#player");
            activeVid = item;
            document.getElementById('videoTitle').innerText = item.title;
            isDone = RankSystem.data.completed.includes(item.id.toString());
            
            vid.src = item.link;
            lastActivityTime = Date.now();
            idleReportSent = false;
            
            const dlContainer = document.getElementById('downloadContainer');
            dlContainer.innerHTML = ""; 
            if(item.attachment && item.attachment.length > 3) {
                const files = item.attachment.split(',');
                files.forEach((fileEntry, index) => {
                    fileEntry = fileEntry.trim();
                    if(!fileEntry) return;
                    let fileName = `ÙØ§ÛŒÙ„ Ø¶Ù…ÛŒÙ…Ù‡ ${toPersianNum(index + 1)}`;
                    let fileLink = fileEntry;
                    if(fileEntry.includes('|')) { const parts = fileEntry.split('|'); fileName = parts[0]; fileLink = parts[1]; }
                    const btn = document.createElement('a');
                    btn.className = 'download-btn'; btn.href = fileLink; btn.target = "_blank";
                    btn.innerHTML = `<div style="display:flex; align-items:center;"><span class="dl-icon">ğŸ“¥</span><span class="dl-text">${fileName}</span></div><span class="dl-arrow">Ø¯Ø±ÛŒØ§ÙØª</span>`;
                    dlContainer.appendChild(btn);
                });
            }

            const cloudTime = RankSystem.getLastPosition(item.id);
            const localKey = `${DB_KEY}${currentUser.username}_time_${item.id}`;
            const localTime = parseFloat(localStorage.getItem(localKey) || 0);
            const isPenaltyActive = localStorage.getItem('forced_penalty_' + item.id);
            let startPos = 0;

            if (cloudTime === 0) {
                localStorage.removeItem(localKey);
                startPos = 0;
            } else if (isPenaltyActive) {
                startPos = localTime;
                RankSystem.savePosition(item.id, localTime, true);
            } else {
                startPos = cloudTime > 0 ? cloudTime : localTime;
            }

            maxTime = isDone ? 999999 : startPos;
            nextCheckTime = maxTime + CHECK_INTERVAL; 
            
            showScreen('screen-player');
            
            if(isDone) {
                 document.getElementById('progressBar').style.width = "100%";
                 document.getElementById('viewPercent').innerText = "Û±Û°Û°Ùª";
                 document.getElementById('viewStatus').innerText = "ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯! âœ…";
            } else {
                document.getElementById('viewStatus').innerText = "Ø¯Ø± Ø­Ø§Ù„ ØªÙ…Ø§Ø´Ø§...";
            }
            
            if(startPos > 5 && !isDone) {
                if(isPenaltyActive || confirm("Ø§Ø¯Ø§Ù…Ù‡ Ù¾Ø®Ø´ Ø§Ø² Ø¬Ø§ÛŒ Ù‚Ø¨Ù„ÛŒØŸ")) {
                    vid.currentTime = startPos;
                } else {
                    vid.currentTime = 0;
                }
            } else {
                vid.currentTime = 0;
            }
            
            if(isPenaltyActive) {
                setTimeout(() => localStorage.removeItem('forced_penalty_' + item.id), 5000);
            }

            SyncManager.addToQueue('report', {
                lesson: item.title, status: 'Ø´Ø±ÙˆØ¹ Ø¯Ø±Ø³', details: 'ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù¾Ù„ÛŒØ±', device: getDeviceInfo()
            });
        }

        function closePlayer() {
            vid.pause();
            if(document.fullscreenElement) document.exitFullscreen();
            checkAndReport("Ø®Ø±ÙˆØ¬ Ø§Ø² Ø¯Ø±Ø³ ğŸ”™", true);
            renderList();
            showScreen('screen-library');
        }

        // Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ÛŒ Ø³ÙØ§Ø±Ø´ÛŒ Ù¾Ù„ÛŒØ±
        function togglePlay() {
            if(vid.paused) vid.play(); else vid.pause();
            updatePlayBtn();
        }
        function updatePlayBtn() {
            document.getElementById('playBtn').innerText = vid.paused ? 'â–¶ï¸' : 'â¸ï¸';
        }
        vid.addEventListener('play', updatePlayBtn);
        vid.addEventListener('pause', updatePlayBtn);
        vid.addEventListener('click', togglePlay);

        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                if(container.requestFullscreen) container.requestFullscreen();
                else if(container.webkitRequestFullscreen) container.webkitRequestFullscreen();
            } else {
                if(document.exitFullscreen) document.exitFullscreen();
            }
        }

        // --- Ù…Ù†Ø·Ù‚ Ø¶Ø¯ ØªÙ‚Ù„Ø¨ Ùˆ Ù¾ÛŒØ´Ø±ÙØª ---
        vid.addEventListener('timeupdate', () => {
            if (isSystemSeeking) return;

            // Ù†Ù…Ø§ÛŒØ´ Ø²Ù…Ø§Ù† Ùˆ Ù†ÙˆØ§Ø± Ù¾ÛŒØ´Ø±ÙØª
            const percent = (vid.currentTime / vid.duration) * 100;
            if(!isNaN(percent)) {
                document.getElementById('progressBar').style.width = percent + "%";
                document.getElementById('viewPercent').innerText = toPersianNum(Math.floor(percent)) + "Ùª";
            }
            const m = Math.floor(vid.currentTime / 60);
            const s = Math.floor(vid.currentTime % 60);
            document.getElementById('timeDisplay').innerText = `${m}:${s < 10 ? '0'+s : s}`;

            if(!vid.seeking && vid.currentTime > maxTime) {
                maxTime = vid.currentTime;
                RankSystem.savePosition(activeVid.id, maxTime);
                localStorage.setItem(`${DB_KEY}${currentUser.username}_time_${activeVid.id}`, maxTime);
                lastActivityTime = Date.now();
                idleReportSent = false; 
            }
            
            if(vid.currentTime > nextCheckTime && !isDone) triggerSecurityCheck();
            
            if(vid.duration && percent >= 98 && !isDone) {
                finishLesson();
            }
        });

        vid.addEventListener('seeking', () => {
            if (isDone) return; 
            if (isSystemSeeking) return;

            // Ø§Ú¯Ø± Ø¨ÛŒØ´ØªØ± Ø§Ø² 3 Ø«Ø§Ù†ÛŒÙ‡ Ø¬Ù„Ùˆ Ø²Ø¯
            if (vid.currentTime > maxTime + 3) {
                isSystemSeeking = true;
                vid.pause();

                // Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¹Ù‚Ø¨
                vid.currentTime = maxTime;
                
                // Ù†Ù…Ø§ÛŒØ´ Ù‡Ø´Ø¯Ø§Ø±
                document.getElementById('cheatAlert').innerText = "â›” Ø¬Ù„Ùˆ Ø²Ø¯Ù† Ù…Ø¬Ø§Ø² Ù†ÛŒØ³Øª!";
                document.getElementById('cheatAlert').style.display = 'block';
                setTimeout(() => document.getElementById('cheatAlert').style.display = 'none', 3000);

                // ğŸ”¥ Ø¬Ø±ÛŒÙ…Ù‡ Ø¢Ù†ÛŒ (Ø§Ø±Ø³Ø§Ù„ ÙÙˆØ±ÛŒ Ø¨Ù‡ Ø³Ø±ÙˆØ±)
                const penaltyPayload = {
                    action: 'sync', username: currentUser.username, password: currentUser.password,
                    jsonData: JSON.stringify(RankSystem.data),
                    force_playback: true 
                };
                fetch(API_URL, {
                    method: 'POST', headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(penaltyPayload)
                }).catch(e=>{});

                setTimeout(() => isSystemSeeking = false, 1000);
            }
        });

        // --- Security Check (Ø³ÙˆØ§Ù„ Ø±ÛŒØ§Ø¶ÛŒ) ---
        function triggerSecurityCheck() {
            vid.pause();
            const n1 = Math.floor(Math.random()*10)+1; const n2 = Math.floor(Math.random()*10)+1;
            correctAnswer = n1 + n2;
            document.getElementById('mathQ').innerText = `${toPersianNum(n1)} + ${toPersianNum(n2)} = ØŸ`;
            document.getElementById('mathAns').value = "";
            document.getElementById('securityModal').style.display = 'flex';
            
            let timeLeft = ANSWER_TIMEOUT;
            document.getElementById('timerDisplay').innerText = toPersianNum(timeLeft);
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timerDisplay').innerText = toPersianNum(timeLeft);
                if(timeLeft <= 0) { clearInterval(timerInterval); punishUser(); }
            }, 1000);
        }

        function checkSecurityAnswer() {
            if(parseInt(toEnglishNum(document.getElementById('mathAns').value)) === correctAnswer) {
                clearInterval(timerInterval);
                document.getElementById('securityModal').style.display = 'none';
                nextCheckTime = vid.currentTime + CHECK_INTERVAL; 
                vid.play();
                lastActivityTime = Date.now(); 
            } else { document.getElementById('mathAns').classList.add('wrong-ans'); }
        }

        function punishUser() {
            document.getElementById('securityModal').style.display = 'none';
            alert("â° Ø²Ù…Ø§Ù† ØªÙ…Ø§Ù… Ø´Ø¯! Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¹Ù‚Ø¨.");
            
            isSystemSeeking = true;
            // 3 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¹Ù‚Ø¨ (ÛŒØ§ Ø´Ø±ÙˆØ¹ ÙÛŒÙ„Ù…)
            let penaltyTime = Math.max(0, vid.currentTime - 180);
            vid.currentTime = penaltyTime; 
            maxTime = penaltyTime; 
            
            const localKey = `${DB_KEY}${currentUser.username}_time_${activeVid.id}`;
            localStorage.setItem(localKey, penaltyTime); 
            localStorage.setItem('forced_penalty_' + activeVid.id, '1');
            
            RankSystem.savePosition(activeVid.id, penaltyTime, true); 
            
            showSyncLoading();
            setTimeout(() => { 
                hideSyncLoading(); 
                isSystemSeeking = false; 
            }, 2000);
        }

        // --- Finish & Confetti ---
        function finishLesson() {
            isDone = true;
            vid.pause();
            document.getElementById('viewStatus').innerText = "ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯! âœ…";
            RankSystem.addXP(100, `ØªÚ©Ù…ÛŒÙ„ Ø¯Ø±Ø³: ${activeVid.title}`, activeVid.id.toString());
            launchConfetti();
            setTimeout(() => alert("ğŸ‰ ØªØ¨Ø±ÛŒÚ©! Ø¯Ø±Ø³ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯ Ùˆ Û±Û°Û° Ø§Ù…ØªÛŒØ§Ø² Ú¯Ø±ÙØªÛŒ."), 500);
            renderList();
        }

        // --- Helper Functions ---
        function checkAndReport(statusMsg, forceSend) {
            if (!activeVid) return;
            const isDonePreviously = RankSystem.data.completed.includes(activeVid.id.toString());
            const currentMin = Math.floor(vid.currentTime/60);
            let finalStatus = statusMsg;
            let finalDetails = `Ø¯Ù‚ÛŒÙ‚Ù‡ ${currentMin}`;
            if(isDonePreviously) {
                finalStatus = statusMsg + " (Ù‚Ø¨Ù„Ø§Ù‹ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡ âœ…)";
                finalDetails = `Ø¨Ø§Ø²Ø¨ÛŒÙ†ÛŒ Ù…Ø¬Ø¯Ø¯ | Ù…ÙˆÙ‚Ø¹ÛŒØª ÙØ¹Ù„ÛŒ: Ø¯Ù‚ÛŒÙ‚Ù‡ ${currentMin}`;
            }
            SyncManager.addToQueue('report', {
                lesson: activeVid.title, status: finalStatus, details: finalDetails, device: getDeviceInfo()
            });
        }

        function showSyncLoading() { document.getElementById('syncOverlay').style.display = 'flex'; }
        function hideSyncLoading() { document.getElementById('syncOverlay').style.display = 'none'; }

        // --- Confetti Animation ---
        function launchConfetti() {
            const canvas = document.getElementById('confetti-canvas');
            canvas.style.display = 'block';
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            const particles = [];
            for(let i=0; i<150; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height - canvas.height,
                    vx: Math.random() * 4 - 2,
                    vy: Math.random() * 4 + 2,
                    c: `hsl(${Math.random()*360}, 100%, 50%)`
                });
            }
            
            function draw() {
                ctx.clearRect(0,0,canvas.width,canvas.height);
                let active = false;
                particles.forEach(p => {
                    p.x += p.vx; p.y += p.vy;
                    if(p.y < canvas.height) active = true;
                    ctx.fillStyle = p.c;
                    ctx.beginPath(); ctx.arc(p.x, p.y, 5, 0, Math.PI*2); ctx.fill();
                });
                if(active) requestAnimationFrame(draw);
                else canvas.style.display = 'none';
            }
            draw();
        }

        // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§
        let fadeTimer;
        container.addEventListener('mousemove', () => {
            document.getElementById('controlsBar').classList.remove('fade-out');
            clearTimeout(fadeTimer);
            fadeTimer = setTimeout(() => {
                if(!vid.paused) document.getElementById('controlsBar').classList.add('fade-out');
            }, 3000);
        });

        // Activity Monitor
        window.addEventListener('blur', () => {
            if (activeVid && !vid.paused && !isDone) {
                vid.pause();
                checkAndReport("âš ï¸ Ø¹Ø¯Ù… ØªÙ…Ø±Ú©Ø² (Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯ÛŒÚ¯Ø±)", true);
            }
        });
        document.addEventListener("visibilitychange", () => {
            if(!activeVid || isDone) return;
            if (document.visibilityState === 'hidden') {
                vid.pause();
                checkAndReport("â›” ØªÙˆÙ‚Ù/Ø®Ø±ÙˆØ¬ (Ù…ÛŒÙ†ÛŒÙ…Ø§ÛŒØ²)", true);
            }
        });
        window.addEventListener('beforeunload', (e) => {
            if (activeVid) checkAndReport("â›” Ø®Ø±ÙˆØ¬ Ù†Ø§Ú¯Ù‡Ø§Ù†ÛŒ", true);
        });
        window.addEventListener('popstate', function(event) {
            if (document.getElementById('screen-player').classList.contains('active')) { closePlayer(); }
        });
        setInterval(() => {
            if (!activeVid || isDone || vid.paused) return; 
            const timeDiff = (Date.now() - lastActivityTime) / 1000;
            if (timeDiff > IDLE_TIMEOUT && !idleReportSent) {
                checkAndReport("âš ï¸ ØªÙˆÙ‚Ù Ø·ÙˆÙ„Ø§Ù†ÛŒ (Ø¹Ø¯Ù… ÙØ¹Ø§Ù„ÛŒØª)", true);
                idleReportSent = true; 
            }
        }, 5000);

    </script>
</body>
</html>
